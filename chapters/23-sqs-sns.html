<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQS & SNS - AWS 기초 강의</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="../index.html" class="header-logo">
      <span class="aws-icon">AWS</span>
      <span>기초 강의</span>
    </a>
  </div>
</header>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li class="sidebar-section">메시징 서비스</li>
      <li><a href="#message-queue">메시지 큐란?</a></li>
      <li><a href="#sqs-concepts">SQS 핵심 개념</a></li>
      <li><a href="#sqs-types">표준 큐 vs FIFO 큐</a></li>
      <li><a href="#sns-concept">SNS란?</a></li>
      <li><a href="#fanout">팬아웃 패턴</a></li>
      <li><a href="#lab">실습</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="chapter-header">
      <span class="chapter-num">Chapter 23</span>
      <h1>SQS & SNS</h1>
      <div class="objectives">
        <h3>학습 목표</h3>
        <ul>
          <li>메시지 큐의 개념과 비동기 처리의 장점을 이해한다</li>
          <li>SQS의 핵심 개념(큐, 메시지, 가시성 타임아웃, 데드레터 큐)을 설명할 수 있다</li>
          <li>SQS 표준 큐와 FIFO 큐의 차이를 비교할 수 있다</li>
          <li>SNS 토픽과 구독의 개념을 이해하고 팬아웃 패턴을 설명할 수 있다</li>
          <li>ShopEasy의 주문 처리를 SQS + SNS를 사용한 비동기 방식으로 구현할 수 있다</li>
        </ul>
      </div>
    </div>

    <!-- Section 1: 메시지 큐란? -->
    <section class="content-section" id="message-queue">
      <h2>메시지 큐란?</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 식당 주문 접수 시스템</div>
        <p>인기 식당에 손님이 몰리면 어떻게 할까요? 주문을 받아서 <strong>주문표에 꽂아두고</strong>, 주방에서 <strong>순서대로 요리</strong>합니다. 손님에게 "잠시만 기다려주세요"라고 하고, 주방은 자기 속도에 맞춰 처리합니다.</p>
        <p>메시지 큐도 같습니다. 주문(메시지)을 큐(주문판)에 넣어두면, 처리하는 쪽(주방)이 자기 속도에 맞춰 하나씩 꺼내서 처리합니다.</p>
      </div>

      <h3>동기 처리 vs 비동기 처리</h3>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 전화 vs 카톡</div>
        <p><strong>동기 처리 (전화)</strong>: 전화를 걸면 상대방이 받을 때까지 기다려야 합니다. 통화가 끝나야 다음 일을 할 수 있죠.</p>
        <p><strong>비동기 처리 (카톡)</strong>: 메시지를 보내고 나면 답장을 기다리지 않고 다른 일을 할 수 있습니다. 상대방이 시간이 될 때 읽고 답장합니다.</p>
      </div>

      <h3>ShopEasy에서의 문제 상황</h3>
      <p>현재 ShopEasy에서 주문이 들어오면:</p>
      <ol>
        <li>결제 처리 (2초)</li>
        <li>재고 업데이트 (1초)</li>
        <li>주문 확인 이메일 발송 (3초)</li>
        <li>관리자에게 알림 전송 (1초)</li>
      </ol>
      <p>사용자는 이 모든 과정이 끝날 때까지 <strong>7초를 기다려야</strong> 합니다. 만약 이메일 서버가 다운되면? <strong>전체 주문이 실패</strong>합니다!</p>

      <h3>메시지 큐를 사용하면?</h3>
      <ol>
        <li>결제 처리 (2초) - 이건 즉시 처리</li>
        <li>"주문 완료" 메시지를 SQS에 넣기 (0.1초)</li>
        <li>사용자에게 "주문 접수 완료!" 응답 (총 2.1초)</li>
      </ol>
      <p>나머지(재고 업데이트, 이메일, 알림)는 SQS에서 메시지를 꺼내서 <strong>백그라운드에서 처리</strong>합니다.</p>

      <div class="diagram">
        <div class="diagram-title">동기 vs 비동기 처리 비교</div>
        <div style="margin-bottom:1.5rem;">
          <div style="font-weight:600; margin-bottom:0.5rem;">[기존: 동기 방식]</div>
          <div class="diagram-row">
            <div class="diagram-box user"><div class="box-title">사용자</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box serverless"><div class="box-title">결제</div><div class="box-sub">2초</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box serverless"><div class="box-title">재고</div><div class="box-sub">1초</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box serverless"><div class="box-title">이메일</div><div class="box-sub">3초</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box serverless"><div class="box-title">알림</div><div class="box-sub">1초</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box user"><div class="box-title">응답</div><div class="box-sub">총 7초</div></div>
          </div>
        </div>
        <div>
          <div style="font-weight:600; margin-bottom:0.5rem;">[개선: 비동기 방식 (SQS)]</div>
          <div class="diagram-row">
            <div class="diagram-box user"><div class="box-title">사용자</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box serverless"><div class="box-title">결제</div><div class="box-sub">2초</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box queue"><div class="box-title">SQS</div><div class="box-sub">메시지 넣기 (0.1초)</div></div>
            <div class="diagram-arrow">&rarr;</div>
            <div class="diagram-box user"><div class="box-title">응답</div><div class="box-sub">총 2.1초</div></div>
          </div>
          <div style="text-align:center; margin:0.5rem 0;">
            <div class="diagram-arrow down">&darr; 백그라운드</div>
          </div>
          <div class="diagram-row" style="justify-content:center;">
            <div class="diagram-box serverless"><div class="box-title">Lambda / Consumer</div><div class="box-sub">재고 업데이트 | 이메일 발송 | 관리자 알림</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section 2: SQS 핵심 개념 -->
    <section class="content-section" id="sqs-concepts">
      <h2>SQS 핵심 개념</h2>

      <p>Amazon SQS(Simple Queue Service)는 AWS에서 제공하는 완전 관리형 메시지 큐 서비스입니다.</p>

      <h3>큐 (Queue)</h3>
      <p>메시지가 저장되는 임시 저장소입니다. 생산자(Producer)가 메시지를 넣고, 소비자(Consumer)가 메시지를 꺼내서 처리합니다.</p>

      <h3>메시지 (Message)</h3>
      <p>큐에 전달되는 데이터 단위입니다. 최대 256KB까지 가능합니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">json</span><button class="copy-btn">복사</button></div>
        <pre><code>{
    "orderId": "ORD-20240115-001",
    "userId": "user123",
    "items": [
        { "productId": "PROD-001", "quantity": 2, "price": 29900 }
    ],
    "totalAmount": 59800,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
      </div>

      <h3>가시성 타임아웃 (Visibility Timeout)</h3>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 도서관 대출</div>
        <p>도서관에서 책을 빌리면(메시지를 가져오면), 반납 기한(가시성 타임아웃) 동안은 다른 사람이 같은 책을 빌릴 수 없습니다. 기한 내에 다 읽고 반납(처리 완료 후 삭제)하면 OK. 기한이 지나도 반납하지 않으면 다시 서가에 꽂혀서(큐에 다시 나타남) 다른 사람이 빌릴 수 있습니다.</p>
      </div>

      <p>소비자가 메시지를 가져가면, 해당 메시지는 <strong>다른 소비자에게 보이지 않습니다</strong>. 가시성 타임아웃 시간 내에 처리를 완료하고 메시지를 삭제해야 합니다. 시간 초과 시 메시지가 다시 큐에 나타나 다른 소비자가 처리할 수 있습니다.</p>

      <ul>
        <li><strong>기본값</strong>: 30초</li>
        <li><strong>범위</strong>: 0초 ~ 12시간</li>
        <li>처리 시간보다 <strong>넉넉하게</strong> 설정해야 중복 처리를 방지</li>
      </ul>

      <h3>데드레터 큐 (Dead Letter Queue, DLQ)</h3>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 반송 우편함</div>
        <p>택배가 여러 번 배송 시도해도 받는 사람이 없으면 "반송 처리"됩니다. 데드레터 큐는 이 반송 우편함입니다. 여러 번 처리에 실패한 메시지를 별도 큐에 보관하여 나중에 원인을 분석할 수 있습니다.</p>
      </div>

      <ul>
        <li><strong>maxReceiveCount</strong>: 몇 번 실패 후 DLQ로 보낼지 (예: 3회)</li>
        <li>DLQ에 쌓인 메시지를 분석하여 오류 원인 파악</li>
        <li>문제 해결 후 DLQ의 메시지를 원래 큐로 재전송 가능</li>
      </ul>

      <h3>메시지 보존 기간</h3>
      <ul>
        <li><strong>기본값</strong>: 4일</li>
        <li><strong>범위</strong>: 1분 ~ 14일</li>
        <li>보존 기간이 지나면 메시지가 자동 삭제됩니다</li>
      </ul>
    </section>

    <!-- Section 3: 표준 큐 vs FIFO 큐 -->
    <section class="content-section" id="sqs-types">
      <h2>SQS 표준 큐 vs FIFO 큐</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 뷔페 vs 번호표 대기</div>
        <p><strong>표준 큐 = 뷔페</strong>: 먼저 온 사람이 먼저 먹을 수도 있고 아닐 수도 있음. 하지만 처리량이 엄청남(사실상 무제한).</p>
        <p><strong>FIFO 큐 = 번호표 대기</strong>: 반드시 순서대로! 먼저 온 사람이 먼저 처리됨. 하지만 한 번에 300건/초로 제한.</p>
      </div>

      <table>
        <thead>
          <tr><th>특성</th><th>표준 큐 (Standard)</th><th>FIFO 큐</th></tr>
        </thead>
        <tbody>
          <tr><td>처리량</td><td>사실상 무제한</td><td>300 TPS (배치: 3,000)</td></tr>
          <tr><td>순서 보장</td><td>최선 노력 (보장 안 됨)</td><td>정확한 순서 보장</td></tr>
          <tr><td>중복 가능성</td><td>가끔 중복 전달 가능</td><td>정확히 한 번 전달</td></tr>
          <tr><td>큐 이름</td><td>자유</td><td>반드시 <code>.fifo</code>로 끝남</td></tr>
          <tr><td>적합한 경우</td><td>대량 처리, 순서 상관없음</td><td>순서가 중요한 처리</td></tr>
          <tr><td>예시</td><td>이메일 발송, 로그 수집</td><td>결제 처리, 주문 상태 변경</td></tr>
        </tbody>
      </table>

      <div class="info-box tip">
        <div class="info-box-title">Tip: ShopEasy에서의 선택</div>
        <p>주문 처리의 경우, 주문이 들어온 순서가 크게 중요하지 않고 처리량이 더 중요하므로 <strong>표준 큐</strong>를 사용합니다. 다만 메시지 중복 가능성이 있으므로, 소비자 측에서 <strong>멱등성(idempotency)</strong> 처리를 해야 합니다 (같은 주문을 두 번 처리하지 않도록).</p>
      </div>
    </section>

    <!-- Section 4: SNS란? -->
    <section class="content-section" id="sns-concept">
      <h2>SNS란?</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 방송 시스템</div>
        <p>학교 방송실에서 "점심시간입니다!"라고 한 번 말하면, <strong>모든 교실의 스피커</strong>에서 동시에 들립니다. 일일이 교실을 돌면서 알려줄 필요 없죠.</p>
        <p>SNS(Simple Notification Service)도 같습니다. 메시지를 한 번 발행하면, 구독하고 있는 <strong>모든 대상</strong>에게 동시에 전달됩니다.</p>
      </div>

      <h3>SNS 핵심 개념</h3>

      <h4>토픽 (Topic)</h4>
      <p>메시지를 발행하는 채널입니다. "주문 알림" 토픽에 메시지를 보내면, 이 토픽을 구독한 모든 대상이 메시지를 받습니다.</p>

      <h4>구독 (Subscription)</h4>
      <p>토픽에 연결된 수신 대상입니다. 다양한 프로토콜을 지원합니다:</p>
      <table>
        <thead>
          <tr><th>프로토콜</th><th>설명</th><th>사용 예시</th></tr>
        </thead>
        <tbody>
          <tr><td><code>Email</code></td><td>이메일로 전송</td><td>관리자 알림</td></tr>
          <tr><td><code>SMS</code></td><td>문자 메시지</td><td>긴급 알림</td></tr>
          <tr><td><code>SQS</code></td><td>SQS 큐로 전달</td><td>비동기 처리 연계</td></tr>
          <tr><td><code>Lambda</code></td><td>Lambda 함수 호출</td><td>자동 처리</td></tr>
          <tr><td><code>HTTP/HTTPS</code></td><td>웹훅 호출</td><td>외부 시스템 연동</td></tr>
        </tbody>
      </table>

      <h4>발행 (Publish)</h4>
      <p>토픽에 메시지를 보내는 행위입니다. 한 번 발행하면 모든 구독자에게 동시 전달됩니다.</p>
    </section>

    <!-- Section 5: 팬아웃 패턴 -->
    <section class="content-section" id="fanout">
      <h2>팬아웃 패턴</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 신문 배달</div>
        <p>신문사(SNS 토픽)에서 신문을 한 번 인쇄하면, 각 가정(SQS 큐)에 동시에 배달됩니다. 한 가정에서 신문을 늦게 읽더라도 다른 가정에는 영향을 주지 않습니다.</p>
      </div>

      <p><strong>팬아웃(Fan-out)</strong>은 하나의 메시지를 여러 대상에게 동시에 전달하는 패턴입니다. SNS + SQS 조합으로 구현합니다.</p>

      <div class="diagram">
        <div class="diagram-title">ShopEasy 주문 팬아웃 패턴</div>
        <div class="diagram-col" style="align-items:center;">
          <div class="diagram-box compute"><div class="box-title">주문 발생</div></div>
          <div class="diagram-arrow down">&darr;</div>
          <div class="diagram-box queue"><div class="box-title">SNS 토픽</div><div class="box-sub">order-notifications</div></div>
        </div>
        <div class="diagram-row" style="margin-top:0.75rem;">
          <div class="diagram-col" style="flex:1; align-items:center;">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box queue"><div class="box-title">SQS 큐 1</div><div class="box-sub">order-processing</div></div>
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box serverless"><div class="box-title">Lambda</div><div class="box-sub">재고 업데이트</div></div>
          </div>
          <div class="diagram-col" style="flex:1; align-items:center;">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box queue"><div class="box-title">SQS 큐 2</div><div class="box-sub">order-email</div></div>
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box serverless"><div class="box-title">Lambda</div><div class="box-sub">확인 이메일 발송</div></div>
          </div>
          <div class="diagram-col" style="flex:1; align-items:center;">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box user"><div class="box-title">Email 구독</div></div>
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box user"><div class="box-title">관리자</div><div class="box-sub">이메일 알림</div></div>
          </div>
          <div class="diagram-col" style="flex:1; align-items:center;">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box queue"><div class="box-title">SQS 큐 3</div><div class="box-sub">order-analytics</div></div>
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box serverless"><div class="box-title">Lambda</div><div class="box-sub">매출 통계 업데이트</div></div>
          </div>
        </div>
      </div>

      <h3>팬아웃의 장점</h3>
      <ul>
        <li><strong>느슨한 결합</strong> - 각 처리 로직이 독립적. 이메일 시스템이 다운되어도 재고 업데이트는 정상 동작</li>
        <li><strong>확장 용이</strong> - 새로운 기능(예: 포인트 적립)을 추가할 때 새 SQS 큐만 구독하면 됨</li>
        <li><strong>병렬 처리</strong> - 모든 작업이 동시에 진행되므로 전체 처리 시간 단축</li>
      </ul>

      <div class="info-box concept">
        <div class="info-box-title">핵심: SQS vs SNS 비교</div>
        <table>
          <thead>
            <tr><th>특성</th><th>SQS</th><th>SNS</th></tr>
          </thead>
          <tbody>
            <tr><td>모델</td><td>풀(Pull) - 소비자가 가져감</td><td>푸시(Push) - 구독자에게 전달</td></tr>
            <tr><td>수신자</td><td>하나의 소비자가 처리</td><td>여러 구독자에게 동시 전달</td></tr>
            <tr><td>메시지 보존</td><td>처리될 때까지 보관</td><td>보관하지 않음 (즉시 전달)</td></tr>
            <tr><td>재시도</td><td>자동 (가시성 타임아웃)</td><td>전달 실패 시 재시도</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Lab Section -->
    <section class="content-section" id="lab">
      <h2>실습</h2>

      <div class="info-box danger">
        <div class="info-box-title">비용 안내</div>
        <p>SQS는 매월 100만 건의 요청이 무료, SNS는 매월 100만 건의 발행이 무료입니다(프리티어). 이 실습은 프리티어 범위 내에서 충분합니다. 이메일 구독은 추가 비용 없습니다.</p>
      </div>

      <div class="lab-section">
        <div class="lab-title">실습: 주문 비동기 처리 시스템 구축</div>
        <ol class="steps">

          <!-- Step 1 -->
          <li class="step">
            <div class="step-title">SQS 큐 생성</div>
            <p>AWS 콘솔에서 <strong>SQS</strong> 서비스로 이동합니다.</p>
            <p><strong>Create queue</strong>를 클릭합니다.</p>
            <ul>
              <li><strong>Type</strong>: <code>Standard</code> (표준 큐)</li>
              <li><strong>Name</strong>: <code>shopeasy-order-processing</code></li>
            </ul>

            <h4>Configuration (설정)</h4>
            <ul>
              <li><strong>Visibility timeout</strong>: <code>60</code>초 (메시지 처리에 충분한 시간)</li>
              <li><strong>Message retention period</strong>: <code>4</code>일 (기본값)</li>
              <li><strong>Delivery delay</strong>: <code>0</code>초</li>
              <li><strong>Maximum message size</strong>: <code>256</code>KB</li>
              <li><strong>Receive message wait time</strong>: <code>20</code>초 (Long Polling - 비용 효율적)</li>
            </ul>

            <div class="info-box tip">
              <div class="info-box-title">Tip: Long Polling (긴 폴링)</div>
              <p>Receive message wait time을 0초(Short Polling)로 하면 메시지가 없어도 즉시 빈 응답을 반환합니다. 20초(Long Polling)로 하면 메시지가 올 때까지 기다렸다가 응답하므로 API 호출 횟수가 줄어 비용이 절약됩니다.</p>
            </div>

            <p><strong>Create queue</strong>를 클릭합니다.</p>
            <div class="screenshot-placeholder">SQS 큐 생성 설정 화면</div>
          </li>

          <!-- Step 2 -->
          <li class="step">
            <div class="step-title">데드레터 큐 설정 (선택)</div>
            <p>처리에 반복적으로 실패하는 메시지를 보관할 DLQ를 만듭니다.</p>
            <p>먼저 DLQ용 큐를 생성합니다:</p>
            <ul>
              <li><strong>Name</strong>: <code>shopeasy-order-processing-dlq</code></li>
              <li>나머지 설정은 기본값</li>
            </ul>
            <p><strong>Create queue</strong>를 클릭합니다.</p>

            <p>다시 <code>shopeasy-order-processing</code> 큐로 돌아가서 <strong>Edit</strong>을 클릭합니다.</p>
            <p><strong>Dead-letter queue</strong> 섹션에서:</p>
            <ul>
              <li><strong>Enabled</strong>: 활성화</li>
              <li><strong>Choose queue</strong>: <code>shopeasy-order-processing-dlq</code> 선택</li>
              <li><strong>Maximum receives</strong>: <code>3</code> (3번 실패 후 DLQ로 이동)</li>
            </ul>
            <p><strong>Save</strong>를 클릭합니다.</p>
            <div class="screenshot-placeholder">데드레터 큐 설정 화면</div>
          </li>

          <!-- Step 3 -->
          <li class="step">
            <div class="step-title">SNS 토픽 생성</div>
            <p>AWS 콘솔에서 <strong>SNS</strong> 서비스로 이동합니다.</p>
            <p><strong>Topics</strong> > <strong>Create topic</strong>을 클릭합니다.</p>
            <ul>
              <li><strong>Type</strong>: <code>Standard</code></li>
              <li><strong>Name</strong>: <code>shopeasy-order-notifications</code></li>
              <li><strong>Display name</strong>: <code>ShopEasy Orders</code></li>
            </ul>
            <p><strong>Create topic</strong>을 클릭합니다.</p>
            <div class="screenshot-placeholder">SNS 토픽 생성 화면</div>
            <p>생성된 토픽의 <strong>ARN</strong>을 메모합니다 (예: <code>arn:aws:sns:ap-northeast-2:123456789012:shopeasy-order-notifications</code>).</p>
          </li>

          <!-- Step 4 -->
          <li class="step">
            <div class="step-title">SNS에 이메일 구독 추가</div>
            <p>토픽 상세 페이지에서 <strong>Create subscription</strong>을 클릭합니다.</p>
            <ul>
              <li><strong>Protocol</strong>: <code>Email</code></li>
              <li><strong>Endpoint</strong>: 본인의 이메일 주소 입력</li>
            </ul>
            <p><strong>Create subscription</strong>을 클릭합니다.</p>

            <div class="info-box warning">
              <div class="info-box-title">중요: 이메일 확인 필수!</div>
              <p>구독을 생성하면 입력한 이메일 주소로 확인 메일이 발송됩니다. 메일함을 확인하여 <strong>"Confirm subscription"</strong> 링크를 클릭해야 구독이 활성화됩니다. 스팸 메일함도 확인하세요!</p>
            </div>

            <p>구독 상태가 <strong>Confirmed</strong>로 변경되었는지 확인합니다.</p>
            <div class="screenshot-placeholder">SNS 이메일 구독 확인 완료</div>
          </li>

          <!-- Step 5 -->
          <li class="step">
            <div class="step-title">SNS에 SQS 구독 추가</div>
            <p>SNS 토픽에 SQS 큐도 구독으로 추가합니다. 이렇게 하면 SNS에 발행된 메시지가 SQS 큐에도 전달됩니다.</p>
            <p><strong>Create subscription</strong>을 클릭합니다.</p>
            <ul>
              <li><strong>Protocol</strong>: <code>Amazon SQS</code></li>
              <li><strong>Endpoint</strong>: <code>shopeasy-order-processing</code> 큐의 ARN 입력</li>
            </ul>
            <p><strong>Create subscription</strong>을 클릭합니다.</p>

            <div class="info-box warning">
              <div class="info-box-title">중요: SQS 큐의 액세스 정책 업데이트</div>
              <p>SNS가 SQS에 메시지를 보내려면 SQS 큐의 액세스 정책에 SNS 권한을 추가해야 합니다.</p>
            </div>

            <p>SQS 콘솔에서 <code>shopeasy-order-processing</code> 큐를 선택하고 <strong>Edit</strong>을 클릭합니다.</p>
            <p><strong>Access policy</strong> 섹션에서 다음 정책을 설정합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">json</span><button class="copy-btn">복사</button></div>
              <pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowSNSToSendMessage",
            "Effect": "Allow",
            "Principal": {
                "Service": "sns.amazonaws.com"
            },
            "Action": "sqs:SendMessage",
            "Resource": "arn:aws:sqs:ap-northeast-2:[계정ID]:shopeasy-order-processing",
            "Condition": {
                "ArnEquals": {
                    "aws:SourceArn": "arn:aws:sns:ap-northeast-2:[계정ID]:shopeasy-order-notifications"
                }
            }
        }
    ]
}</code></pre>
            </div>
            <p><strong>Save</strong>를 클릭합니다.</p>
          </li>

          <!-- Step 6 -->
          <li class="step">
            <div class="step-title">Lambda 함수: SQS 메시지 처리</div>
            <p>SQS 큐에서 메시지를 가져와 처리하는 Lambda 함수를 만듭니다.</p>
            <p><strong>Lambda</strong> > <strong>Create function</strong></p>
            <ul>
              <li><strong>Function name</strong>: <code>shopeasy-order-processor</code></li>
              <li><strong>Runtime</strong>: <code>Node.js 20.x</code></li>
              <li><strong>Architecture</strong>: <code>arm64</code></li>
            </ul>
            <p>코드를 작성합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">javascript</span><button class="copy-btn">복사</button></div>
              <pre><code>export const handler = async (event) => {
    console.log("SQS 메시지 수신:", JSON.stringify(event, null, 2));

    for (const record of event.Records) {
        try {
            // SNS를 통해 온 메시지는 body 안에 다시 Message가 있음
            let orderData;
            const body = JSON.parse(record.body);

            if (body.Type === 'Notification') {
                // SNS를 통해 온 메시지
                orderData = JSON.parse(body.Message);
            } else {
                // SQS에 직접 보낸 메시지
                orderData = body;
            }

            console.log("주문 처리 시작:", orderData.orderId);

            // 1. 재고 업데이트 시뮬레이션
            console.log(`재고 업데이트: ${orderData.items?.length || 0}개 상품`);
            await new Promise(resolve => setTimeout(resolve, 500));

            // 2. 주문 상태 업데이트 시뮬레이션
            console.log(`주문 상태 변경: ${orderData.orderId} → "처리 중"`);
            await new Promise(resolve => setTimeout(resolve, 300));

            // 3. 처리 완료 로그
            console.log(`주문 처리 완료: ${orderData.orderId}`);
            console.log(`총 금액: ${orderData.totalAmount?.toLocaleString()}원`);

        } catch (error) {
            console.error("주문 처리 실패:", error);
            // 에러 발생 시 메시지가 다시 큐에 나타남 (가시성 타임아웃 후)
            throw error;
        }
    }

    return {
        statusCode: 200,
        body: JSON.stringify({ message: '주문 처리 완료' })
    };
};</code></pre>
            </div>
            <p><strong>Deploy</strong>를 클릭합니다.</p>

            <p>IAM 역할에 SQS 권한을 추가합니다:</p>
            <p><strong>Configuration</strong> > <strong>Permissions</strong> > 역할 이름 클릭 > <strong>Add permissions</strong> > <strong>Attach policies</strong></p>
            <p><code>AWSLambdaSQSQueueExecutionRole</code>을 검색하여 추가합니다.</p>
          </li>

          <!-- Step 7 -->
          <li class="step">
            <div class="step-title">Lambda에 SQS 트리거 추가</div>
            <p>Lambda 함수 상세 페이지에서 <strong>Add trigger</strong>를 클릭합니다.</p>
            <ul>
              <li><strong>Trigger</strong>: <code>SQS</code></li>
              <li><strong>SQS queue</strong>: <code>shopeasy-order-processing</code></li>
              <li><strong>Batch size</strong>: <code>10</code> (한 번에 최대 10개 메시지 처리)</li>
              <li><strong>Batch window</strong>: <code>0</code>초</li>
            </ul>
            <p><strong>Add</strong>를 클릭합니다.</p>
            <div class="screenshot-placeholder">Lambda SQS 트리거 추가 화면</div>
          </li>

          <!-- Step 8 -->
          <li class="step">
            <div class="step-title">API 서버 환경변수 변경</div>
            <p>API 서버(EC2)에 SSH로 접속하여 환경변수를 업데이트합니다.</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">bash</span><button class="copy-btn">복사</button></div>
              <pre><code># EC2에 SSH 접속 후
cd /home/ec2-user/shopeasy-api

# .env 파일 수정
sudo nano .env</code></pre>
            </div>
            <p>다음 환경변수를 추가/변경합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">env</span><button class="copy-btn">복사</button></div>
              <pre><code># 메시징 설정
QUEUE_TYPE=sqs
SQS_QUEUE_URL=https://sqs.ap-northeast-2.amazonaws.com/[계정ID]/shopeasy-order-processing
SNS_TOPIC_ARN=arn:aws:sns:ap-northeast-2:[계정ID]:shopeasy-order-notifications
AWS_REGION=ap-northeast-2</code></pre>
            </div>
            <div class="info-box tip">
              <div class="info-box-title">Tip: EC2에 SQS/SNS 권한 부여</div>
              <p>EC2의 IAM 역할에 <code>AmazonSQSFullAccess</code>와 <code>AmazonSNSFullAccess</code> 정책을 추가해야 합니다. EC2 콘솔 > 인스턴스 > Actions > Security > Modify IAM role에서 설정합니다.</p>
            </div>
          </li>

          <!-- Step 9 -->
          <li class="step">
            <div class="step-title">API 서버 재시작</div>
            <div class="code-block">
              <div class="code-header"><span class="lang">bash</span><button class="copy-btn">복사</button></div>
              <pre><code># PM2를 사용하는 경우
pm2 restart all

# 또는 직접 재시작
sudo systemctl restart shopeasy-api</code></pre>
            </div>
          </li>

          <!-- Step 10 -->
          <li class="step">
            <div class="step-title">SNS 테스트 메시지 발행</div>
            <p>먼저 SNS에서 직접 테스트 메시지를 발행하여 이메일과 SQS가 정상 동작하는지 확인합니다.</p>
            <p>SNS 콘솔 > <code>shopeasy-order-notifications</code> 토픽 > <strong>Publish message</strong></p>
            <ul>
              <li><strong>Subject</strong>: <code>테스트 주문 알림</code></li>
              <li><strong>Message body</strong>:</li>
            </ul>
            <div class="code-block">
              <div class="code-header"><span class="lang">json</span><button class="copy-btn">복사</button></div>
              <pre><code>{
    "orderId": "ORD-TEST-001",
    "userId": "testUser",
    "items": [
        {
            "productId": "PROD-001",
            "name": "무선 마우스",
            "quantity": 1,
            "price": 29900
        }
    ],
    "totalAmount": 29900,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
            </div>
            <p><strong>Publish message</strong>를 클릭합니다.</p>

            <p>확인 사항:</p>
            <ul>
              <li>이메일로 알림이 오는지 확인 (1~2분 소요)</li>
              <li>SQS 콘솔에서 메시지가 큐에 들어갔는지 확인</li>
              <li>Lambda의 CloudWatch Logs에서 메시지 처리 로그 확인</li>
            </ul>
            <div class="screenshot-placeholder">SNS 테스트 메시지 발행 후 이메일 수신 확인</div>
          </li>

          <!-- Step 11 -->
          <li class="step">
            <div class="step-title">SQS 큐에서 메시지 확인</div>
            <p>SQS 콘솔에서 <code>shopeasy-order-processing</code> 큐를 선택합니다.</p>
            <p><strong>Send and receive messages</strong> > <strong>Poll for messages</strong>를 클릭합니다.</p>
            <p>Lambda가 정상 처리했다면 큐가 비어 있을 것입니다. Lambda가 메시지를 가져가서 처리했기 때문입니다.</p>
            <p>만약 메시지가 남아 있다면 Lambda 처리에 문제가 있는 것이므로 CloudWatch Logs를 확인합니다.</p>
            <div class="screenshot-placeholder">SQS 큐 메시지 확인 화면</div>
          </li>

          <!-- Step 12 -->
          <li class="step">
            <div class="step-title">브라우저에서 주문 테스트</div>
            <p>ShopEasy 웹사이트에서 실제 주문을 해봅니다:</p>
            <ol>
              <li>상품을 장바구니에 담기</li>
              <li>주문하기 클릭</li>
              <li>주문 완료 확인 (빠른 응답!)</li>
              <li>이메일로 주문 알림 수신 확인</li>
              <li>CloudWatch Logs에서 Lambda 처리 로그 확인</li>
            </ol>
            <div class="screenshot-placeholder">ShopEasy 주문 후 이메일 알림 수신 화면</div>

            <div class="info-box concept">
              <div class="info-box-title">체감 차이</div>
              <p>이전에는 주문 버튼을 누르면 모든 처리가 끝날 때까지 로딩이 돌았지만, 이제는 결제만 완료되면 즉시 응답이 옵니다. 나머지 처리(알림, 재고 업데이트)는 백그라운드에서 비동기적으로 수행됩니다.</p>
            </div>
          </li>

        </ol>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">정리: SQS & SNS 활용 요약</div>
        <ul>
          <li><strong>SQS</strong> - 메시지를 안전하게 보관하고 순서대로 처리 (생산자-소비자 패턴)</li>
          <li><strong>SNS</strong> - 하나의 메시지를 여러 대상에게 동시 전달 (발행-구독 패턴)</li>
          <li><strong>팬아웃</strong> - SNS → 여러 SQS 큐로 동시 전달하여 병렬 처리</li>
          <li><strong>DLQ</strong> - 처리 실패 메시지를 별도 보관하여 문제 분석</li>
          <li><strong>비동기 처리</strong> - 사용자 응답 시간 단축, 시스템 안정성 향상</li>
        </ul>
      </div>
    </section>

    <div class="chapter-nav">
      <a href="22-api-gateway-lambda.html" class="prev">이전: API Gateway + Lambda</a>
      <a href="24-elasticache.html" class="next">다음: ElastiCache</a>
    </div>
  </main>
</div>

<script src="../assets/js/main.js"></script>
</body>

</html>
