<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudFormation - AWS 기초 강의</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="../index.html" class="header-logo">
      <span class="aws-icon">AWS</span>
      <span>기초 강의</span>
    </a>
  </div>
</header>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li class="sidebar-section">IaC & CloudFormation</li>
      <li><a href="#iac-concept">IaC란?</a></li>
      <li><a href="#cloudformation-benefits">CloudFormation 장점</a></li>
      <li><a href="#template-structure">템플릿 구조</a></li>
      <li><a href="#references">리소스 간 참조</a></li>
      <li><a href="#stack-lifecycle">스택 생성/업데이트/삭제</a></li>
      <li><a href="#lab">실습</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="chapter-header">
      <span class="chapter-num">Chapter 26</span>
      <h1>CloudFormation</h1>
      <div class="objectives">
        <h3>학습 목표</h3>
        <ul>
          <li>IaC(Infrastructure as Code)의 개념과 장점을 이해한다</li>
          <li>CloudFormation 템플릿의 구조(Parameters, Resources, Outputs)를 설명할 수 있다</li>
          <li>리소스 간 참조(!Ref, !GetAtt)를 사용할 수 있다</li>
          <li>CloudFormation 스택을 생성, 업데이트, 삭제할 수 있다</li>
          <li>ShopEasy 이커머스 인프라를 코드로 정의할 수 있다</li>
        </ul>
      </div>
    </div>

    <!-- Section 1: IaC란? -->
    <section class="content-section" id="iac-concept">
      <h2>IaC(Infrastructure as Code)란?</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 레고 설명서</div>
        <p>레고를 조립할 때 설명서가 있으면 <strong>누가 만들어도 같은 결과</strong>가 나오죠. 설명서 없이 기억에 의존하면 매번 다르게 만들어지고, 다른 사람에게 전달하기도 어렵습니다.</p>
        <p>IaC는 인프라의 "레고 설명서"입니다. 서버, 네트워크, 데이터베이스를 <strong>코드(텍스트 파일)로 정의</strong>하면, 똑같은 인프라를 누구든지, 언제든지, 어디서든지 만들 수 있습니다.</p>
      </div>

      <h3>콘솔 클릭 vs IaC 비교</h3>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 요리 레시피</div>
        <p><strong>콘솔 클릭 = 눈대중으로 요리</strong>: "소금 좀 넣고, 간장 좀 넣고..." 매번 맛이 다름. 다른 사람에게 전수 불가.</p>
        <p><strong>IaC = 요리 레시피</strong>: "소금 1 티스푼, 간장 2 스푼" 정확하게 적혀 있음. 누가 만들어도 같은 맛!</p>
      </div>

      <table>
        <thead>
          <tr><th>비교 항목</th><th>콘솔 클릭 (수동)</th><th>IaC (코드)</th></tr>
        </thead>
        <tbody>
          <tr><td>재현성</td><td>매번 다를 수 있음</td><td>항상 동일한 결과</td></tr>
          <tr><td>속도</td><td>느림 (하나씩 클릭)</td><td>빠름 (자동 생성)</td></tr>
          <tr><td>버전 관리</td><td>불가능</td><td>Git으로 관리 가능</td></tr>
          <tr><td>문서화</td><td>별도 문서 필요</td><td>코드 자체가 문서</td></tr>
          <tr><td>팀 협업</td><td>어려움 (스크린샷?)</td><td>코드 리뷰 가능</td></tr>
          <tr><td>실수 복구</td><td>어려움 (무엇이 달라졌지?)</td><td>이전 버전으로 롤백</td></tr>
          <tr><td>환경 복제</td><td>처음부터 다시 클릭</td><td>템플릿 실행 한 번으로 복제</td></tr>
        </tbody>
      </table>

      <h3>실무에서 IaC가 필수인 이유</h3>
      <ul>
        <li><strong>개발/스테이징/운영 환경 일치</strong> - 같은 템플릿으로 환경별 인프라 생성</li>
        <li><strong>재해 복구(DR)</strong> - 다른 리전에 동일한 인프라를 빠르게 생성</li>
        <li><strong>감사(Audit)</strong> - 인프라 변경 이력을 Git으로 추적</li>
        <li><strong>비용 관리</strong> - 스택 삭제 한 번으로 모든 리소스 정리</li>
      </ul>
    </section>

    <!-- Section 2: CloudFormation 장점 -->
    <section class="content-section" id="cloudformation-benefits">
      <h2>CloudFormation 장점</h2>

      <p>CloudFormation은 AWS의 기본 IaC 서비스입니다. 추가 설치 없이 바로 사용할 수 있습니다.</p>

      <h3>주요 장점</h3>
      <ul>
        <li><strong>무료</strong> - CloudFormation 자체는 무료. 생성되는 리소스에만 비용 발생</li>
        <li><strong>AWS 네이티브</strong> - 새 AWS 서비스 출시 시 즉시 지원</li>
        <li><strong>의존성 자동 관리</strong> - VPC를 먼저 만들고, 그 다음 서브넷... 순서를 자동으로 처리</li>
        <li><strong>롤백</strong> - 생성 중 오류 발생 시 자동으로 이전 상태로 복원</li>
        <li><strong>드리프트 감지</strong> - 콘솔에서 수동 변경된 리소스를 감지</li>
      </ul>

      <h3>CloudFormation vs Terraform</h3>
      <table>
        <thead>
          <tr><th>특성</th><th>CloudFormation</th><th>Terraform</th></tr>
        </thead>
        <tbody>
          <tr><td>제공자</td><td>AWS 자체 서비스</td><td>HashiCorp (서드파티)</td></tr>
          <tr><td>지원 클라우드</td><td>AWS만</td><td>AWS, GCP, Azure 등 다중 클라우드</td></tr>
          <tr><td>언어</td><td>YAML / JSON</td><td>HCL (HashiCorp Configuration Language)</td></tr>
          <tr><td>비용</td><td>무료</td><td>오픈소스 무료 / Enterprise 유료</td></tr>
          <tr><td>추천 상황</td><td>AWS만 사용할 때</td><td>멀티 클라우드</td></tr>
        </tbody>
      </table>

      <div class="info-box tip">
        <div class="info-box-title">Tip: 우리 과정에서는 CloudFormation</div>
        <p>AWS만 사용하는 환경에서는 CloudFormation이 가장 자연스럽습니다. 추가 설치가 필요 없고, AWS 서비스와의 통합이 완벽합니다. 실무에서 멀티 클라우드를 사용한다면 Terraform도 배워두면 좋습니다.</p>
      </div>
    </section>

    <!-- Section 3: 템플릿 구조 -->
    <section class="content-section" id="template-structure">
      <h2>템플릿 구조</h2>

      <p>CloudFormation 템플릿은 YAML 또는 JSON으로 작성합니다. YAML이 더 읽기 쉬워서 권장됩니다.</p>

      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code>AWSTemplateFormatVersion: '2010-09-09'    # 템플릿 버전 (고정값)
Description: 'ShopEasy 인프라 템플릿'       # 설명

# === 파라미터: 사용자 입력값 ===
Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: '환경 이름'

  InstanceType:
    Type: String
    Default: t3.micro
    Description: 'EC2 인스턴스 타입'

# === 리소스: 실제 생성할 AWS 리소스 ===
Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-vpc'

  MySubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC    # MyVPC 리소스 참조
      CidrBlock: 10.0.1.0/24

# === 출력: 생성된 리소스 정보 ===
Outputs:
  VPCId:
    Description: 'VPC ID'
    Value: !Ref MyVPC
    Export:
      Name: !Sub '${EnvironmentName}-VPCId'</code></pre>
      </div>

      <h3>템플릿 주요 섹션</h3>
      <table>
        <thead>
          <tr><th>섹션</th><th>필수</th><th>역할</th></tr>
        </thead>
        <tbody>
          <tr><td><code>AWSTemplateFormatVersion</code></td><td>선택</td><td>템플릿 형식 버전 (항상 '2010-09-09')</td></tr>
          <tr><td><code>Description</code></td><td>선택</td><td>템플릿 설명</td></tr>
          <tr><td><code>Parameters</code></td><td>선택</td><td>사용자 입력 파라미터 (환경별 다른 값)</td></tr>
          <tr><td><code>Mappings</code></td><td>선택</td><td>키-값 매핑 (리전별 AMI ID 등)</td></tr>
          <tr><td><code>Conditions</code></td><td>선택</td><td>조건부 리소스 생성</td></tr>
          <tr><td><code>Resources</code></td><td><strong>필수</strong></td><td>생성할 AWS 리소스 정의</td></tr>
          <tr><td><code>Outputs</code></td><td>선택</td><td>생성된 리소스 정보 출력</td></tr>
        </tbody>
      </table>

      <h3>Parameters (파라미터)</h3>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 주문 양식의 옵션</div>
        <p>커피를 주문할 때 "사이즈"를 선택하는 것처럼, 파라미터는 템플릿을 실행할 때 선택하는 옵션입니다. 같은 템플릿으로 "dev"에서는 t3.micro, "prod"에서는 t3.large를 사용할 수 있습니다.</p>
      </div>

      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code>Parameters:
  # 문자열 파라미터
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: '환경 이름 (dev/staging/prod)'

  # 숫자 파라미터
  InstanceCount:
    Type: Number
    Default: 2
    MinValue: 1
    MaxValue: 10
    Description: 'EC2 인스턴스 수'

  # AWS 특수 파라미터 (드롭다운에서 선택)
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: '기존 키페어 선택'

  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: '기존 VPC 선택'</code></pre>
      </div>

      <h3>Resources (리소스)</h3>
      <p>템플릿의 핵심 섹션으로, 실제 생성할 AWS 리소스를 정의합니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code>Resources:
  # 논리적 이름 (템플릿 내에서 참조용)
  WebServerInstance:
    Type: AWS::EC2::Instance     # 리소스 유형
    Properties:                  # 리소스 속성
      ImageId: ami-0c55b159cbfafe1f0
      InstanceType: !Ref InstanceType  # 파라미터 참조
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref WebServerSG      # 다른 리소스 참조
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-web-server'

  WebServerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'Web server security group'
      VpcId: !Ref MyVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0</code></pre>
      </div>

      <h3>Outputs (출력)</h3>
      <p>스택 생성 후 중요한 정보를 출력합니다. 다른 스택에서 참조할 수도 있습니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code>Outputs:
  WebServerPublicIP:
    Description: '웹 서버 퍼블릭 IP'
    Value: !GetAtt WebServerInstance.PublicIp

  WebServerURL:
    Description: '웹 서버 URL'
    Value: !Sub 'http://${WebServerInstance.PublicDnsName}'

  VPCId:
    Description: 'VPC ID'
    Value: !Ref MyVPC
    Export:
      Name: !Sub '${EnvironmentName}-VPCId'  # 다른 스택에서 참조 가능</code></pre>
      </div>
    </section>

    <!-- Section 4: 리소스 간 참조 -->
    <section class="content-section" id="references">
      <h2>리소스 간 참조</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 주소 쓰기</div>
        <p>편지를 쓸 때 "서울시 강남구..."라고 주소를 직접 쓸 수도 있지만, "김철수 집 주소"라고 참조할 수도 있죠. CloudFormation에서도 리소스의 ID나 속성을 직접 쓰지 않고, <code>!Ref</code>로 "저 리소스의 ID"라고 참조합니다.</p>
      </div>

      <h3>!Ref (레퍼런스)</h3>
      <p>리소스의 기본 식별자(보통 ID)를 반환합니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code># !Ref 사용 예시
Resources:
  MyVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16

  MySubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyVPC    # MyVPC의 ID를 자동으로 가져옴
      CidrBlock: 10.0.1.0/24

# 파라미터도 !Ref로 참조
  MyInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType  # 파라미터 값 참조</code></pre>
      </div>

      <h3>!GetAtt (GetAttribute)</h3>
      <p>리소스의 특정 속성값을 가져옵니다. !Ref로는 ID만 가져올 수 있지만, !GetAtt으로는 다양한 속성을 가져올 수 있습니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code># !GetAtt 사용 예시
Outputs:
  InstancePublicIP:
    Value: !GetAtt MyInstance.PublicIp         # EC2의 퍼블릭 IP

  InstancePrivateIP:
    Value: !GetAtt MyInstance.PrivateIp        # EC2의 프라이빗 IP

  VPCDefaultSG:
    Value: !GetAtt MyVPC.DefaultSecurityGroup  # VPC의 기본 보안그룹

  RDSEndpoint:
    Value: !GetAtt MyRDS.Endpoint.Address      # RDS의 엔드포인트 주소</code></pre>
      </div>

      <h3>!Sub (Substitute)</h3>
      <p>문자열 내에 변수를 삽입합니다. 템플릿 리터럴과 비슷합니다.</p>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code># !Sub 사용 예시
Resources:
  MyBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'shopeasy-${EnvironmentName}-${AWS::AccountId}'
      # 결과: shopeasy-dev-123456789012

Tags:
  - Key: Name
    Value: !Sub '${EnvironmentName}-web-server'
    # 결과: dev-web-server</code></pre>
      </div>

      <h3>!Join, !Select 등 기타 내장 함수</h3>
      <div class="code-block">
        <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
        <pre><code># !Join - 문자열 결합
Value: !Join ['-', ['shopeasy', !Ref EnvironmentName, 'vpc']]
# 결과: shopeasy-dev-vpc

# !Select - 리스트에서 선택
Value: !Select [0, !GetAZs '']  # 첫 번째 가용영역

# !If - 조건부 값
Value: !If [IsProd, 't3.large', 't3.micro']</code></pre>
      </div>
    </section>

    <!-- Section 5: 스택 생성/업데이트/삭제 -->
    <section class="content-section" id="stack-lifecycle">
      <h2>스택 생성/업데이트/삭제</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 건물 관리</div>
        <p><strong>스택 생성</strong> = 설계도(템플릿)대로 건물 짓기<br>
        <strong>스택 업데이트</strong> = 기존 건물 리모델링 (증축, 변경)<br>
        <strong>스택 삭제</strong> = 건물 철거 (모든 것이 깔끔하게 제거됨)</p>
      </div>

      <h3>스택 (Stack)</h3>
      <p>CloudFormation 템플릿으로 생성된 리소스들의 묶음입니다. 스택을 삭제하면 해당 스택으로 생성된 모든 리소스가 함께 삭제됩니다.</p>

      <h3>스택 생성 과정</h3>
      <ol>
        <li>템플릿 업로드 (YAML 파일)</li>
        <li>파라미터 입력 (환경, 인스턴스 타입 등)</li>
        <li>CloudFormation이 리소스 의존성 분석</li>
        <li>의존성 순서대로 리소스 생성 (VPC → 서브넷 → EC2)</li>
        <li>모든 리소스 생성 완료 → 스택 상태: <code>CREATE_COMPLETE</code></li>
      </ol>

      <h3>스택 상태</h3>
      <table>
        <thead>
          <tr><th>상태</th><th>설명</th></tr>
        </thead>
        <tbody>
          <tr><td><code>CREATE_IN_PROGRESS</code></td><td>리소스 생성 중</td></tr>
          <tr><td><code>CREATE_COMPLETE</code></td><td>모든 리소스 생성 완료</td></tr>
          <tr><td><code>CREATE_FAILED</code></td><td>생성 실패 (자동 롤백)</td></tr>
          <tr><td><code>ROLLBACK_COMPLETE</code></td><td>실패 후 롤백 완료</td></tr>
          <tr><td><code>UPDATE_IN_PROGRESS</code></td><td>스택 업데이트 중</td></tr>
          <tr><td><code>UPDATE_COMPLETE</code></td><td>업데이트 완료</td></tr>
          <tr><td><code>DELETE_IN_PROGRESS</code></td><td>스택 삭제 중</td></tr>
          <tr><td><code>DELETE_COMPLETE</code></td><td>삭제 완료</td></tr>
        </tbody>
      </table>

      <div class="info-box warning">
        <div class="info-box-title">주의: 스택 삭제 시 모든 리소스가 삭제됩니다</div>
        <p>스택을 삭제하면 해당 스택으로 생성된 <strong>모든</strong> 리소스가 삭제됩니다. RDS, S3 등 데이터가 있는 리소스도 함께 삭제되므로 주의하세요! 중요한 데이터가 있다면 <code>DeletionPolicy: Retain</code>을 설정하거나 삭제 전에 백업하세요.</p>
      </div>
    </section>

    <!-- Lab Section -->
    <section class="content-section" id="lab">
      <h2>실습</h2>

      <div class="info-box danger">
        <div class="info-box-title">비용 안내</div>
        <p>CloudFormation 자체는 무료이지만, 템플릿으로 생성되는 리소스(EC2, VPC 등)에 비용이 발생합니다. <strong>실습 후 반드시 스택을 삭제하여 모든 리소스를 정리하세요.</strong> 스택 삭제 한 번으로 모든 리소스가 깔끔하게 제거됩니다.</p>
      </div>

      <div class="lab-section">
        <div class="lab-title">실습 A: 간단한 S3 버킷 템플릿</div>
        <ol class="steps">

          <!-- Step 1 -->
          <li class="step">
            <div class="step-title">S3 버킷 템플릿 작성</div>
            <p>로컬 컴퓨터에서 텍스트 편집기를 열고 다음 내용을 <code>s3-bucket.yaml</code>로 저장합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
              <pre><code>AWSTemplateFormatVersion: '2010-09-09'
Description: 'ShopEasy - S3 버킷 생성 (CloudFormation 첫 실습)'

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: '환경 이름'

  BucketPurpose:
    Type: String
    Default: assets
    Description: '버킷 용도 (예: assets, logs, backup)'

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'shopeasy-${BucketPurpose}-${EnvironmentName}-${AWS::AccountId}'
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Project
          Value: ShopEasy
        - Key: ManagedBy
          Value: CloudFormation
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

Outputs:
  BucketName:
    Description: '생성된 S3 버킷 이름'
    Value: !Ref S3Bucket

  BucketArn:
    Description: '버킷 ARN'
    Value: !GetAtt S3Bucket.Arn

  BucketDomainName:
    Description: '버킷 도메인'
    Value: !GetAtt S3Bucket.DomainName</code></pre>
            </div>
          </li>

          <!-- Step 2 -->
          <li class="step">
            <div class="step-title">스택 생성</div>
            <p>AWS 콘솔에서 <strong>CloudFormation</strong> 서비스로 이동합니다.</p>
            <p><strong>Create stack</strong> > <strong>With new resources (standard)</strong>를 클릭합니다.</p>

            <h4>Step 1: 템플릿 지정</h4>
            <ul>
              <li><strong>Prepare template</strong>: <code>Template is ready</code></li>
              <li><strong>Template source</strong>: <code>Upload a template file</code></li>
              <li><strong>Choose file</strong>: <code>s3-bucket.yaml</code> 파일 선택</li>
            </ul>
            <p><strong>Next</strong>를 클릭합니다.</p>

            <h4>Step 2: 스택 세부 정보</h4>
            <ul>
              <li><strong>Stack name</strong>: <code>shopeasy-s3-test</code></li>
              <li><strong>EnvironmentName</strong>: <code>dev</code></li>
              <li><strong>BucketPurpose</strong>: <code>assets</code></li>
            </ul>
            <p><strong>Next</strong>를 클릭합니다.</p>

            <h4>Step 3: 스택 옵션</h4>
            <p>기본값으로 두고 <strong>Next</strong>를 클릭합니다.</p>

            <h4>Step 4: 검토 및 생성</h4>
            <p>설정을 검토하고 <strong>Submit</strong>을 클릭합니다.</p>
            <div class="screenshot-placeholder">CloudFormation 스택 생성 - 템플릿 업로드 및 파라미터 입력</div>
          </li>

          <!-- Step 3 -->
          <li class="step">
            <div class="step-title">스택 생성 과정 확인</div>
            <p>스택 상세 페이지에서 <strong>Events</strong> 탭을 확인합니다.</p>
            <p>리소스가 생성되는 과정을 실시간으로 볼 수 있습니다:</p>
            <ul>
              <li><code>CREATE_IN_PROGRESS</code> - S3Bucket</li>
              <li><code>CREATE_COMPLETE</code> - S3Bucket</li>
              <li><code>CREATE_COMPLETE</code> - shopeasy-s3-test (스택 전체 완료)</li>
            </ul>
            <p><strong>Outputs</strong> 탭에서 생성된 버킷 이름, ARN, 도메인을 확인합니다.</p>
            <p><strong>Resources</strong> 탭에서 생성된 리소스 목록과 Physical ID(실제 리소스 ID)를 확인합니다.</p>
            <div class="screenshot-placeholder">CloudFormation 스택 이벤트 - 리소스 생성 과정</div>
          </li>

          <!-- Step 4 -->
          <li class="step">
            <div class="step-title">S3 콘솔에서 확인</div>
            <p>S3 콘솔로 이동하여 <code>shopeasy-assets-dev-[계정ID]</code> 버킷이 생성되었는지 확인합니다.</p>
            <p>버킷의 태그를 확인합니다: Environment=dev, Project=ShopEasy, ManagedBy=CloudFormation</p>
            <div class="screenshot-placeholder">S3 콘솔 - CloudFormation으로 생성된 버킷 확인</div>
          </li>

          <!-- Step 5 -->
          <li class="step">
            <div class="step-title">스택 삭제 (정리)</div>
            <p>CloudFormation 콘솔에서 <code>shopeasy-s3-test</code> 스택을 선택합니다.</p>
            <p><strong>Delete</strong>를 클릭합니다.</p>
            <p>확인 대화상자에서 <strong>Delete</strong>를 클릭합니다.</p>
            <p>Events 탭에서 삭제 과정을 확인합니다. S3 버킷이 자동으로 삭제됩니다.</p>

            <div class="info-box warning">
              <div class="info-box-title">주의: S3 버킷에 파일이 있으면 삭제 실패</div>
              <p>S3 버킷에 파일이 있으면 CloudFormation이 버킷을 삭제하지 못하고 <code>DELETE_FAILED</code>가 됩니다. 버킷을 먼저 비우거나, 템플릿에서 <code>DeletionPolicy: Delete</code>와 함께 Lambda를 사용하여 자동으로 비우는 방법이 있습니다.</p>
            </div>
            <div class="screenshot-placeholder">CloudFormation 스택 삭제 과정</div>
          </li>

        </ol>
      </div>

      <div class="lab-section">
        <div class="lab-title">실습 B: 이커머스 VPC 템플릿</div>
        <ol class="steps">

          <!-- Step 1 -->
          <li class="step">
            <div class="step-title">VPC 템플릿 작성</div>
            <p><code>vpc-template.yaml</code> 파일을 생성합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
              <pre><code>AWSTemplateFormatVersion: '2010-09-09'
Description: 'ShopEasy VPC - 퍼블릭/프라이빗 서브넷 4개 + IGW + 라우팅'

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: 'VPC CIDR 블록'

Resources:
  # === VPC ===
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-shopeasy-vpc'

  # === 인터넷 게이트웨이 ===
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-igw'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # === 퍼블릭 서브넷 ===
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-2'

  # === 프라이빗 서브넷 ===
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.12.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-2'

  # === 퍼블릭 라우트 테이블 ===
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # === 프라이빗 라우트 테이블 ===
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-private-rt'

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

Outputs:
  VPCId:
    Description: 'VPC ID'
    Value: !Ref VPC
    Export:
      Name: !Sub '${EnvironmentName}-VPCId'

  PublicSubnet1Id:
    Description: '퍼블릭 서브넷 1 ID'
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${EnvironmentName}-PublicSubnet1Id'

  PublicSubnet2Id:
    Description: '퍼블릭 서브넷 2 ID'
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${EnvironmentName}-PublicSubnet2Id'

  PrivateSubnet1Id:
    Description: '프라이빗 서브넷 1 ID'
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${EnvironmentName}-PrivateSubnet1Id'

  PrivateSubnet2Id:
    Description: '프라이빗 서브넷 2 ID'
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${EnvironmentName}-PrivateSubnet2Id'</code></pre>
            </div>
          </li>

          <!-- Step 2 -->
          <li class="step">
            <div class="step-title">VPC 스택 생성</div>
            <p>CloudFormation 콘솔에서 <strong>Create stack</strong>을 클릭합니다.</p>
            <ul>
              <li><strong>Template</strong>: <code>vpc-template.yaml</code> 업로드</li>
              <li><strong>Stack name</strong>: <code>shopeasy-vpc</code></li>
              <li><strong>EnvironmentName</strong>: <code>dev</code></li>
              <li><strong>VpcCidr</strong>: <code>10.0.0.0/16</code> (기본값)</li>
            </ul>
            <p><strong>Submit</strong>을 클릭합니다.</p>

            <p>또는 AWS CLI로 생성할 수도 있습니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">bash</span><button class="copy-btn">복사</button></div>
              <pre><code>aws cloudformation create-stack \
    --stack-name shopeasy-vpc \
    --template-body file://vpc-template.yaml \
    --parameters \
        ParameterKey=EnvironmentName,ParameterValue=dev \
        ParameterKey=VpcCidr,ParameterValue=10.0.0.0/16</code></pre>
            </div>
            <div class="screenshot-placeholder">VPC 스택 생성 과정 - Events 탭</div>
          </li>

          <!-- Step 3 -->
          <li class="step">
            <div class="step-title">생성된 리소스 확인</div>
            <p>스택 상태가 <code>CREATE_COMPLETE</code>가 되면, 다음을 확인합니다:</p>

            <h4>CloudFormation Outputs 탭</h4>
            <p>VPC ID, 서브넷 ID들이 출력됩니다.</p>

            <h4>VPC 콘솔에서 확인</h4>
            <p>VPC 콘솔로 이동하여 생성된 리소스를 확인합니다:</p>
            <ul>
              <li>VPC: <code>dev-shopeasy-vpc</code></li>
              <li>퍼블릭 서브넷 2개: <code>dev-public-1</code>, <code>dev-public-2</code></li>
              <li>프라이빗 서브넷 2개: <code>dev-private-1</code>, <code>dev-private-2</code></li>
              <li>인터넷 게이트웨이: <code>dev-igw</code></li>
              <li>라우트 테이블: <code>dev-public-rt</code>, <code>dev-private-rt</code></li>
            </ul>
            <div class="screenshot-placeholder">VPC 콘솔 - CloudFormation으로 생성된 VPC 리소스들</div>

            <div class="info-box concept">
              <div class="info-box-title">핵심 포인트</div>
              <p>콘솔에서 하나하나 클릭하면 10~15분 걸리던 작업이, CloudFormation 템플릿 한 번 실행으로 <strong>2~3분 만에 자동 완료</strong>되었습니다. 이 템플릿을 다른 리전이나 다른 계정에서 실행하면 똑같은 VPC를 즉시 만들 수 있습니다.</p>
            </div>
          </li>

        </ol>
      </div>

      <div class="lab-section">
        <div class="lab-title">실습 C: EC2 + 보안그룹 템플릿</div>
        <ol class="steps">

          <!-- Step 1 -->
          <li class="step">
            <div class="step-title">EC2 템플릿 작성</div>
            <p><code>ec2-template.yaml</code> 파일을 생성합니다. 이 템플릿은 VPC 스택의 출력을 참조합니다:</p>
            <div class="code-block">
              <div class="code-header"><span class="lang">yaml</span><button class="copy-btn">복사</button></div>
              <pre><code>AWSTemplateFormatVersion: '2010-09-09'
Description: 'ShopEasy EC2 - API 서버 + 보안그룹 + UserData 자동 설정'

Parameters:
  EnvironmentName:
    Type: String
    Default: dev

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues: [t3.micro, t3.small, t3.medium]

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: '기존 키페어 선택'

  LatestAmiId:
    Type: AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-arm64
    Description: '최신 Amazon Linux 2023 AMI (arm64)'

Resources:
  # === API 서버 보안그룹 ===
  APIServerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 'ShopEasy API Server Security Group'
      VpcId:
        Fn::ImportValue: !Sub '${EnvironmentName}-VPCId'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: 'SSH access'
        - IpProtocol: tcp
          FromPort: 3000
          ToPort: 3000
          CidrIp: 0.0.0.0/0
          Description: 'API server port'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: 'HTTP access'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-api-sg'

  # === EC2 인스턴스 ===
  APIServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      KeyName: !Ref KeyPairName
      SubnetId:
        Fn::ImportValue: !Sub '${EnvironmentName}-PublicSubnet1Id'
      SecurityGroupIds:
        - !Ref APIServerSG
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-api-server'
        - Key: Project
          Value: ShopEasy
        - Key: ManagedBy
          Value: CloudFormation
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e

          # 시스템 업데이트
          dnf update -y

          # Node.js 20 설치
          dnf install -y nodejs20 npm git

          # 프로젝트 디렉토리 생성
          mkdir -p /home/ec2-user/shopeasy-api
          cd /home/ec2-user/shopeasy-api

          # 간단한 헬스체크 API 생성
          cat > server.js << 'SERVEREOF'
          const http = require('http');
          const server = http.createServer((req, res) => {
              if (req.url === '/health') {
                  res.writeHead(200, {'Content-Type': 'application/json'});
                  res.end(JSON.stringify({
                      status: 'healthy',
                      environment: '${EnvironmentName}',
                      timestamp: new Date().toISOString()
                  }));
              } else {
                  res.writeHead(200, {'Content-Type': 'application/json'});
                  res.end(JSON.stringify({
                      message: 'ShopEasy API Server',
                      environment: '${EnvironmentName}'
                  }));
              }
          });
          server.listen(3000, () => console.log('Server running on port 3000'));
          SERVEREOF

          # 소유권 변경
          chown -R ec2-user:ec2-user /home/ec2-user/shopeasy-api

          # 서버 시작
          cd /home/ec2-user/shopeasy-api
          sudo -u ec2-user node server.js &

Outputs:
  InstanceId:
    Description: 'EC2 인스턴스 ID'
    Value: !Ref APIServer

  PublicIP:
    Description: '퍼블릭 IP'
    Value: !GetAtt APIServer.PublicIp

  PublicDNS:
    Description: '퍼블릭 DNS'
    Value: !GetAtt APIServer.PublicDnsName

  APIEndpoint:
    Description: 'API 엔드포인트'
    Value: !Sub 'http://${APIServer.PublicDnsName}:3000'

  HealthCheckURL:
    Description: '헬스체크 URL'
    Value: !Sub 'http://${APIServer.PublicDnsName}:3000/health'

  SecurityGroupId:
    Description: '보안그룹 ID'
    Value: !Ref APIServerSG</code></pre>
            </div>
          </li>

          <!-- Step 2 -->
          <li class="step">
            <div class="step-title">EC2 스택 생성</div>
            <p>CloudFormation 콘솔에서 스택을 생성합니다.</p>
            <ul>
              <li><strong>Template</strong>: <code>ec2-template.yaml</code> 업로드</li>
              <li><strong>Stack name</strong>: <code>shopeasy-ec2</code></li>
              <li><strong>EnvironmentName</strong>: <code>dev</code> (VPC 스택과 동일해야 함!)</li>
              <li><strong>InstanceType</strong>: <code>t3.micro</code></li>
              <li><strong>KeyPairName</strong>: 기존 키페어 선택</li>
            </ul>
            <p><strong>IAM 관련 체크박스</strong>에 체크하고 <strong>Submit</strong>을 클릭합니다.</p>
            <div class="screenshot-placeholder">EC2 스택 생성 - 파라미터 입력</div>
          </li>

          <!-- Step 3 -->
          <li class="step">
            <div class="step-title">자동으로 생성된 인프라 확인</div>
            <p>스택이 <code>CREATE_COMPLETE</code>가 되면:</p>

            <h4>Outputs 탭 확인</h4>
            <p>API 엔드포인트 URL과 헬스체크 URL을 확인합니다.</p>

            <h4>EC2 콘솔에서 확인</h4>
            <ul>
              <li>인스턴스가 running 상태인지</li>
              <li>보안그룹이 올바르게 연결되었는지</li>
              <li>VPC 스택에서 생성한 퍼블릭 서브넷에 배치되었는지</li>
            </ul>

            <h4>API 테스트</h4>
            <div class="code-block">
              <div class="code-header"><span class="lang">bash</span><button class="copy-btn">복사</button></div>
              <pre><code># Outputs에서 확인한 URL로 테스트
curl http://[퍼블릭DNS]:3000/health

# 응답 예시:
# {"status":"healthy","environment":"dev","timestamp":"2024-01-15T14:30:00.000Z"}</code></pre>
            </div>

            <div class="info-box concept">
              <div class="info-box-title">UserData의 위력</div>
              <p>EC2가 시작되면서 UserData 스크립트가 자동으로 실행되어 Node.js 설치, API 서버 코드 작성, 서버 시작까지 모두 자동으로 완료됩니다. 수동으로 SSH 접속하여 설정할 필요가 없습니다!</p>
            </div>
          </li>

          <!-- Step 4 -->
          <li class="step">
            <div class="step-title">스택 삭제 (모든 리소스 자동 정리)</div>
            <p>실습이 끝났으므로 스택을 삭제하여 리소스를 정리합니다.</p>
            <p><strong>중요: EC2 스택을 먼저 삭제한 후, VPC 스택을 삭제합니다.</strong> (EC2가 VPC를 참조하고 있으므로)</p>

            <h4>1) EC2 스택 삭제</h4>
            <p>CloudFormation > <code>shopeasy-ec2</code> 스택 선택 > <strong>Delete</strong></p>
            <p>EC2 인스턴스, 보안그룹이 자동으로 삭제됩니다.</p>

            <h4>2) VPC 스택 삭제</h4>
            <p>EC2 스택 삭제 완료 후, <code>shopeasy-vpc</code> 스택 선택 > <strong>Delete</strong></p>
            <p>VPC, 서브넷, IGW, 라우트 테이블이 모두 자동으로 삭제됩니다.</p>

            <div class="code-block">
              <div class="code-header"><span class="lang">bash</span><button class="copy-btn">복사</button></div>
              <pre><code># AWS CLI로 스택 삭제 (순서대로)
aws cloudformation delete-stack --stack-name shopeasy-ec2

# EC2 스택 삭제 완료 대기
aws cloudformation wait stack-delete-complete --stack-name shopeasy-ec2

# VPC 스택 삭제
aws cloudformation delete-stack --stack-name shopeasy-vpc

# VPC 스택 삭제 완료 대기
aws cloudformation wait stack-delete-complete --stack-name shopeasy-vpc

echo "모든 스택 삭제 완료!"</code></pre>
            </div>
            <div class="screenshot-placeholder">스택 삭제 후 모든 리소스가 정리된 CloudFormation 콘솔</div>

            <div class="info-box tip">
              <div class="info-box-title">Tip: 스택 삭제의 편리함</div>
              <p>콘솔에서 일일이 리소스를 삭제하면 순서도 맞춰야 하고, 빠뜨리기 쉽습니다. CloudFormation은 <strong>스택 삭제 한 번으로 모든 리소스를 자동 정리</strong>합니다. 실습 비용 관리에 매우 유용합니다!</p>
            </div>
          </li>

        </ol>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">정리: CloudFormation 핵심 요약</div>
        <ul>
          <li><strong>IaC</strong> - 인프라를 코드로 관리. 재현 가능, 버전 관리, 자동화</li>
          <li><strong>템플릿</strong> - YAML/JSON으로 리소스 정의 (Parameters, Resources, Outputs)</li>
          <li><strong>스택</strong> - 템플릿으로 생성된 리소스 묶음. 삭제 시 모든 리소스 함께 제거</li>
          <li><strong>!Ref</strong> - 리소스 ID/파라미터 값 참조</li>
          <li><strong>!GetAtt</strong> - 리소스의 특정 속성 참조</li>
          <li><strong>!Sub</strong> - 문자열에 변수 삽입</li>
          <li><strong>Export/Import</strong> - 스택 간 값 공유</li>
        </ul>
      </div>

      <div class="info-box analogy">
        <div class="info-box-title">수업 전체 회고</div>
        <p>지금까지 우리는 ShopEasy 이커머스 앱을 로컬에서 시작하여 AWS의 다양한 서비스에 배포해왔습니다:</p>
        <ul>
          <li><strong>EC2</strong>: 서버 배포</li>
          <li><strong>VPC</strong>: 네트워크 분리</li>
          <li><strong>ALB + Auto Scaling</strong>: 부하 분산과 자동 확장</li>
          <li><strong>RDS</strong>: 관리형 데이터베이스</li>
          <li><strong>DynamoDB</strong>: NoSQL 리뷰 시스템</li>
          <li><strong>S3</strong>: 사진 저장, 프론트엔드 호스팅</li>
          <li><strong>CloudFront</strong>: CDN으로 빠른 전달</li>
          <li><strong>Lambda</strong>: 서버리스 이미지 처리, 검색 API</li>
          <li><strong>API Gateway</strong>: REST API 관리</li>
          <li><strong>SQS & SNS</strong>: 비동기 주문 처리</li>
          <li><strong>ElastiCache</strong>: Redis 캐싱</li>
          <li><strong>CloudWatch</strong>: 모니터링과 경보</li>
          <li><strong>CloudFormation</strong>: 인프라 코드화</li>
        </ul>
        <p>이 모든 것을 CloudFormation 템플릿으로 정의하면, <strong>버튼 한 번으로 전체 인프라를 생성/삭제</strong>할 수 있습니다. 이것이 클라우드 인프라의 힘입니다!</p>
      </div>
    </section>

    <div class="chapter-nav">
      <a href="25-cloudwatch.html" class="prev">이전: CloudWatch</a>
      <a href="../index.html" class="next">다음: 목차로 돌아가기</a>
    </div>
  </main>
</div>

<script src="../assets/js/main.js"></script>
</body>

</html>
