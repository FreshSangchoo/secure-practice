<!DOCTYPE html>
<html lang="ko">

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/04-iam-roles-sts.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IAM 역할 & 임시 자격증명 - AWS 클라우드 보안</title>
  <link href="../../cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="../index.html" class="header-logo">
      <span class="aws-icon">&#x1F6E1; AWS Security</span>
      <span>클라우드 보안 강의</span>
    </a>
  </div>
</header>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li><a href="#role-vs-user">IAM 역할 vs 사용자</a></li>
      <li><a href="#trust-policy">신뢰 정책 (Trust Policy)</a></li>
      <li><a href="#instance-profile">EC2 인스턴스 프로파일</a></li>
      <li><a href="#sts-assume-role">STS & AssumeRole</a></li>
      <li><a href="#cross-account">크로스 계정 역할 전환</a></li>
      <li><a href="#lab-roles">실습: 역할 & 임시 자격증명</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="chapter-header">
      <span class="chapter-num">Chapter 04</span>
      <h1>IAM 역할 & 임시 자격증명</h1>
      <div class="objectives">
        <h3>학습 목표</h3>
        <ul>
          <li>IAM 역할과 IAM 사용자의 차이를 설명하고, 역할이 보안적으로 우수한 이유를 이해한다</li>
          <li>신뢰 정책(Trust Policy)의 구조를 이해하고, 누가 역할을 맡을 수 있는지 제어할 수 있다</li>
          <li>EC2 인스턴스 프로파일을 생성하여 EC2에서 안전하게 AWS 서비스에 접근할 수 있다</li>
          <li>STS(Security Token Service)의 동작 원리와 임시 자격증명의 수명 주기를 이해한다</li>
          <li>AssumeRole을 사용하여 크로스 계정 접근을 설정할 수 있다</li>
        </ul>
      </div>
    </div>

    <!-- ==================== 섹션 1: IAM 역할 vs 사용자 ==================== -->
    <section class="content-section" id="role-vs-user">
      <h2>1. IAM 역할 vs 사용자</h2>

      <p>
        IAM에는 두 가지 주요 자격증명 유형이 있습니다: <strong>사용자(User)</strong>와 <strong>역할(Role)</strong>.
        기초 과정에서는 IAM 사용자를 만들어 Access Key로 AWS에 접근했지만,
        실무에서는 <strong>가능한 한 IAM 역할을 사용하는 것이 보안 모범 사례</strong>입니다.
      </p>

      <h3>1.1 IAM 사용자의 보안 문제</h3>

      <p>
        IAM 사용자는 <strong>장기 자격증명(Long-term Credentials)</strong>을 사용합니다.
        Access Key ID와 Secret Access Key가 한 번 발급되면 수동으로 로테이션하거나 삭제하기 전까지 영구적으로 유효합니다.
      </p>

      <div class="info-box danger">
        <div class="info-box-title">장기 자격증명의 위험성</div>
        <p>
          <strong>유출 위험:</strong> .env 파일, Git 커밋, 로그, 환경변수 등을 통해 Access Key가 노출될 수 있습니다.<br>
          <strong>공유 문제:</strong> 한 명에게 발급된 Key가 팀원 간에 공유되거나, 퇴사 후에도 유효할 수 있습니다.<br>
          <strong>로테이션 부담:</strong> 수동으로 Key를 교체해야 하며, 교체 시 모든 사용처를 업데이트해야 합니다.<br>
          <strong>실제 사례:</strong> GitHub에 AWS Access Key가 커밋되면, 봇이 수 분 내에 해당 Key를 탐지하여 비트코인 채굴 인스턴스를 수천 개 생성한 사례가 있습니다.
        </p>
      </div>

      <h3>1.2 IAM 역할의 장점</h3>

      <p>
        IAM 역할은 <strong>임시 자격증명(Temporary Credentials)</strong>을 사용합니다.
        역할을 "맡으면(assume)" STS가 제한된 시간 동안만 유효한 자격증명을 발급합니다.
      </p>

      <table>
        <thead>
          <tr>
            <th>비교 항목</th>
            <th>IAM 사용자</th>
            <th>IAM 역할</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>자격증명 유형</strong></td>
            <td>장기 자격증명 (Access Key)</td>
            <td>임시 자격증명 (STS Token)</td>
          </tr>
          <tr>
            <td><strong>유효 기간</strong></td>
            <td>수동 삭제 전까지 영구</td>
            <td>15분 ~ 12시간 (자동 만료)</td>
          </tr>
          <tr>
            <td><strong>사용 주체</strong></td>
            <td>특정 사람 또는 애플리케이션</td>
            <td>사람, 서비스, 다른 계정 등 다양한 주체</td>
          </tr>
          <tr>
            <td><strong>로테이션</strong></td>
            <td>수동 (최대 90일 권장)</td>
            <td>자동 (만료 후 재발급)</td>
          </tr>
          <tr>
            <td><strong>공유 위험</strong></td>
            <td>높음 (키 유출 가능)</td>
            <td>낮음 (임시 토큰, 자동 만료)</td>
          </tr>
          <tr>
            <td><strong>감사(Audit)</strong></td>
            <td>Access Key 기반 추적</td>
            <td>세션별 추적 가능 (SessionName)</td>
          </tr>
          <tr>
            <td><strong>사용 사례</strong></td>
            <td>콘솔 로그인, CLI 직접 사용</td>
            <td>EC2, Lambda, 크로스 계정, Federation</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 마스터키 vs 호텔 카드키</div>
        <p>
          <strong>IAM 사용자(Access Key)</strong>는 <strong>마스터키</strong>와 같습니다.
          한 번 받으면 잃어버리기 전까지 영원히 사용할 수 있고, 복제해서 다른 사람에게 줄 수도 있습니다.
          분실하면 큰 보안 사고로 이어집니다.<br><br>
          <strong>IAM 역할(임시 자격증명)</strong>은 <strong>호텔 카드키</strong>와 같습니다.
          체크인(AssumeRole)할 때 발급받고, 체크아웃 시간(만료 시간)이 되면 자동으로 비활성화됩니다.
          잃어버려도 시간이 지나면 쓸 수 없게 됩니다.
        </p>
      </div>

      <h3>1.3 IAM 역할의 구성 요소</h3>

      <p>IAM 역할은 두 가지 정책으로 구성됩니다:</p>

      <div class="diagram">
        <div class="diagram-title">IAM 역할의 구성 요소</div>
        <div class="diagram-row">
          <div class="diagram-box iam">
            <div class="box-title">IAM 역할</div>
            <div class="box-sub">shopeasy-api-role</div>
          </div>
        </div>
        <div class="diagram-row" style="gap: 2rem;">
          <div class="diagram-col">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box security">
              <div class="box-title">신뢰 정책 (Trust Policy)</div>
              <div class="box-sub">누가 이 역할을 맡을 수 있는가?<br>(Principal 정의)</div>
            </div>
          </div>
          <div class="diagram-col">
            <div class="diagram-arrow down">&darr;</div>
            <div class="diagram-box compute">
              <div class="box-title">권한 정책 (Permission Policy)</div>
              <div class="box-sub">이 역할을 맡으면 무엇을 할 수 있는가?<br>(Action, Resource 정의)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">두 가지 정책의 역할</div>
        <p>
          <strong>신뢰 정책(Trust Policy):</strong> "이 역할을 누가 맡을(Assume) 수 있는가?" &mdash;
          EC2 서비스, 특정 IAM 사용자, 다른 AWS 계정 등을 Principal로 지정합니다.<br>
          <strong>권한 정책(Permission Policy):</strong> "이 역할을 맡은 후 무엇을 할 수 있는가?" &mdash;
          Chapter 03에서 배운 일반적인 IAM 정책과 동일합니다.
        </p>
      </div>
    </section>

    <!-- ==================== 섹션 2: 신뢰 정책 (Trust Policy) ==================== -->
    <section class="content-section" id="trust-policy">
      <h2>2. 신뢰 정책 (Trust Policy)</h2>

      <p>
        신뢰 정책은 IAM 역할의 핵심으로, <strong>누가(Principal) 이 역할을 맡을(Assume) 수 있는가</strong>를 정의합니다.
        역할의 "문지기" 역할을 합니다. 신뢰 정책에 지정되지 않은 주체는 아무리 AssumeRole을 시도해도 거부됩니다.
      </p>

      <h3>2.1 신뢰 정책 기본 구조</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
      </div>

      <p>
        위 예시는 <strong>EC2 서비스</strong>가 이 역할을 맡을 수 있다는 의미입니다.
        EC2 인스턴스에 이 역할을 연결하면, 인스턴스 내부에서 별도의 Access Key 없이 AWS API를 호출할 수 있습니다.
      </p>

      <h3>2.2 Principal 유형별 신뢰 정책</h3>

      <table>
        <thead>
          <tr>
            <th>Principal 유형</th>
            <th>형식</th>
            <th>사용 사례</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>AWS 서비스</strong></td>
            <td><code>"Service": "ec2.amazonaws.com"</code></td>
            <td>EC2, Lambda, ECS 등이 역할을 사용</td>
          </tr>
          <tr>
            <td><strong>IAM 사용자</strong></td>
            <td><code>"AWS": "arn:aws:iam::123456789012:user/admin"</code></td>
            <td>특정 사용자가 역할 전환</td>
          </tr>
          <tr>
            <td><strong>IAM 역할</strong></td>
            <td><code>"AWS": "arn:aws:iam::123456789012:role/other-role"</code></td>
            <td>역할 체이닝 (Role Chaining)</td>
          </tr>
          <tr>
            <td><strong>다른 AWS 계정</strong></td>
            <td><code>"AWS": "arn:aws:iam::987654321098:root"</code></td>
            <td>크로스 계정 접근</td>
          </tr>
          <tr>
            <td><strong>모든 주체</strong></td>
            <td><code>"AWS": "*"</code></td>
            <td>퍼블릭 (매우 위험, Condition 필수)</td>
          </tr>
          <tr>
            <td><strong>SAML 공급자</strong></td>
            <td><code>"Federated": "arn:aws:iam::...:saml-provider/..."</code></td>
            <td>SSO, ADFS, Okta 페더레이션</td>
          </tr>
          <tr>
            <td><strong>웹 자격증명</strong></td>
            <td><code>"Federated": "cognito-identity.amazonaws.com"</code></td>
            <td>Cognito, Google, Facebook 로그인</td>
          </tr>
        </tbody>
      </table>

      <h3>2.3 주요 서비스별 신뢰 정책 예시</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// EC2 인스턴스용 역할
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "ec2.amazonaws.com" },
    "Action": "sts:AssumeRole"
  }]
}

// Lambda 함수용 역할
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "lambda.amazonaws.com" },
    "Action": "sts:AssumeRole"
  }]
}

// ECS 태스크용 역할
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "ecs-tasks.amazonaws.com" },
    "Action": "sts:AssumeRole"
  }]
}</code></pre>
      </div>

      <h3>2.4 Condition을 활용한 신뢰 정책 강화</h3>

      <p>
        신뢰 정책에도 Condition을 추가하여 역할을 맡을 수 있는 조건을 더 세밀하게 제어할 수 있습니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::987654321098:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "Bool": {
          "aws:MultiFactorAuthPresent": "true"
        },
        "StringEquals": {
          "sts:ExternalId": "ShopEasy-Partner-2024"
        }
      }
    }
  ]
}</code></pre>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">ExternalId의 역할: 혼동된 대리인 문제 방지</div>
        <p>
          <strong>혼동된 대리인(Confused Deputy)</strong> 문제란, 제3자 서비스가 여러 고객의 역할을 맡을 때
          악의적인 고객이 다른 고객의 역할을 빼앗을 수 있는 보안 문제입니다.<br>
          <code>ExternalId</code>는 역할을 맡을 때 반드시 제시해야 하는 "비밀번호" 역할을 하여 이를 방지합니다.
          크로스 계정 역할에서 제3자 서비스와 연동할 때 반드시 설정해야 합니다.
        </p>
      </div>
    </section>

    <!-- ==================== 섹션 3: EC2 인스턴스 프로파일 ==================== -->
    <section class="content-section" id="instance-profile">
      <h2>3. EC2 인스턴스 프로파일</h2>

      <p>
        EC2 인스턴스에서 AWS 서비스에 접근해야 할 때, Access Key를 하드코딩하는 대신
        <strong>인스턴스 프로파일(Instance Profile)</strong>을 사용하는 것이 보안 모범 사례입니다.
        인스턴스 프로파일은 IAM 역할을 EC2 인스턴스에 연결하는 "컨테이너"입니다.
      </p>

      <h3>3.1 인스턴스 프로파일 동작 원리</h3>

      <div class="diagram">
        <div class="diagram-title">EC2 인스턴스 프로파일 동작 흐름</div>
        <div class="diagram-row">
          <div class="diagram-box compute">
            <div class="box-title">EC2 인스턴스</div>
            <div class="box-sub">ShopEasy API 서버</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box iam">
            <div class="box-title">인스턴스 프로파일</div>
            <div class="box-sub">shopeasy-api-profile</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box iam">
            <div class="box-title">IAM 역할</div>
            <div class="box-sub">shopeasy-api-role</div>
          </div>
        </div>
        <div class="diagram-arrow down">&darr;</div>
        <div class="diagram-row">
          <div class="diagram-box security">
            <div class="box-title">IMDS (Instance Metadata Service)</div>
            <div class="box-sub">http://169.254.169.254/latest/meta-data/iam/security-credentials/</div>
          </div>
        </div>
        <div class="diagram-arrow down">&darr; 임시 자격증명 자동 발급</div>
        <div class="diagram-row">
          <div class="diagram-box storage">
            <div class="box-title">S3</div>
            <div class="box-sub">상품 이미지</div>
          </div>
          <div class="diagram-box database">
            <div class="box-title">DynamoDB</div>
            <div class="box-sub">세션 데이터</div>
          </div>
          <div class="diagram-box queue">
            <div class="box-title">SQS</div>
            <div class="box-sub">주문 큐</div>
          </div>
        </div>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">IMDS (Instance Metadata Service)</div>
        <p>
          EC2 인스턴스 내부에서 <code>http://169.254.169.254</code>에 HTTP 요청을 보내면
          인스턴스 메타데이터(AMI ID, 인스턴스 유형 등)와 <strong>IAM 역할의 임시 자격증명</strong>을 받을 수 있습니다.
          AWS SDK는 이 메커니즘을 자동으로 사용하므로, 코드에 Access Key를 넣을 필요가 없습니다.
        </p>
      </div>

      <h3>3.2 IMDSv1 vs IMDSv2</h3>

      <p>
        IMDS에는 v1과 v2가 있으며, <strong>보안을 위해 반드시 IMDSv2를 사용</strong>해야 합니다.
      </p>

      <table>
        <thead>
          <tr>
            <th>항목</th>
            <th>IMDSv1</th>
            <th>IMDSv2 (권장)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>요청 방식</strong></td>
            <td>단순 GET 요청</td>
            <td>PUT으로 토큰 발급 &rarr; GET에 토큰 포함</td>
          </tr>
          <tr>
            <td><strong>SSRF 취약점</strong></td>
            <td>취약 (토큰 없이 접근 가능)</td>
            <td>방어 (세션 토큰 필요, hop limit 설정)</td>
          </tr>
          <tr>
            <td><strong>토큰 TTL</strong></td>
            <td>없음</td>
            <td>1초 ~ 6시간 (기본 6시간)</td>
          </tr>
          <tr>
            <td><strong>HTTP hop limit</strong></td>
            <td>기본 1 (컨테이너에서 접근 가능)</td>
            <td>설정 가능 (Docker에서는 2로 설정)</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box danger">
        <div class="info-box-title">SSRF를 통한 자격증명 탈취 (Capital One 사례)</div>
        <p>
          2019년 Capital One 해킹 사건에서 공격자는 웹 애플리케이션의 <strong>SSRF(Server-Side Request Forgery)</strong> 취약점을 이용하여
          IMDSv1 엔드포인트(<code>http://169.254.169.254</code>)에 접근, EC2 역할의 임시 자격증명을 탈취했습니다.
          이 자격증명으로 S3 버킷에 접근하여 1억 명 이상의 고객 데이터가 유출되었습니다.<br><br>
          <strong>대응책:</strong> IMDSv2를 강제하고, 인스턴스의 http-put-response-hop-limit을 1로 설정하면
          외부에서의 SSRF 공격을 통한 메타데이터 접근을 차단할 수 있습니다.
        </p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># IMDSv1 (비권장) - 단순 GET으로 자격증명 접근 가능
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/shopeasy-api-role

# IMDSv2 (권장) - 세션 토큰 필요
# Step 1: PUT으로 세션 토큰 발급
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

# Step 2: 토큰을 포함하여 자격증명 조회
curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/shopeasy-api-role</code></pre>
      </div>

      <h3>3.3 IMDSv2 강제 설정</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 기존 인스턴스에 IMDSv2 강제 적용
aws ec2 modify-instance-metadata-options \
  --instance-id i-0123456789abcdef0 \
  --http-tokens required \
  --http-endpoint enabled \
  --http-put-response-hop-limit 1

# 새 인스턴스 시작 시 IMDSv2 강제
aws ec2 run-instances \
  --image-id ami-0abcdef1234567890 \
  --instance-type t3.micro \
  --metadata-options "HttpTokens=required,HttpEndpoint=enabled,HttpPutResponseHopLimit=1" \
  --iam-instance-profile Name=shopeasy-api-profile</code></pre>
      </div>

      <div class="info-box best-practice">
        <div class="info-box-title">인스턴스 프로파일 모범 사례</div>
        <p>
          1. <strong>항상 인스턴스 프로파일 사용:</strong> EC2에 Access Key를 절대 넣지 마세요<br>
          2. <strong>IMDSv2 강제:</strong> 모든 인스턴스에서 IMDSv1을 비활성화하세요<br>
          3. <strong>역할당 최소 권한:</strong> 각 EC2 인스턴스에 필요한 최소한의 권한만 가진 역할을 부여하세요<br>
          4. <strong>hop limit 1:</strong> 컨테이너를 사용하지 않으면 hop limit을 1로 설정하세요 (Docker 사용 시 2)<br>
          5. <strong>AWS Config 규칙:</strong> <code>ec2-imdsv2-check</code> 규칙으로 IMDSv2 미적용 인스턴스를 자동 탐지하세요
        </p>
      </div>

      <h3>3.4 ShopEasy에서 Access Key 제거하기</h3>

      <p>
        ShopEasy API 서버가 현재 <code>.env</code> 파일에 Access Key를 저장하고 있다면,
        이를 인스턴스 프로파일로 전환해야 합니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">javascript</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// 변경 전: .env 파일에 Access Key 하드코딩 (위험!)
const AWS = require('aws-sdk');
AWS.config.update({
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,        // 장기 자격증명
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY, // 유출 시 영구 접근 가능
  region: 'ap-northeast-2'
});

// 변경 후: 인스턴스 프로파일 사용 (안전!)
const AWS = require('aws-sdk');
// 별도 설정 불필요 - SDK가 자동으로 인스턴스 프로파일에서 자격증명 획득
const s3 = new AWS.S3({ region: 'ap-northeast-2' });</code></pre>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">AWS SDK의 자격증명 탐색 순서 (Credential Provider Chain)</div>
        <p>
          AWS SDK는 다음 순서로 자격증명을 자동 탐색합니다:<br>
          1. 환경변수 (<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>)<br>
          2. 공유 자격증명 파일 (<code>~/.aws/credentials</code>)<br>
          3. ECS 컨테이너 자격증명 (<code>AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>)<br>
          4. <strong>EC2 인스턴스 프로파일 (IMDS)</strong> &larr; 프로덕션에서 이것을 사용<br>
          환경변수나 .env 파일에 Key가 없으면 SDK가 자동으로 인스턴스 프로파일을 사용합니다.
        </p>
      </div>
    </section>

    <!-- ==================== 섹션 4: STS & AssumeRole ==================== -->
    <section class="content-section" id="sts-assume-role">
      <h2>4. STS & AssumeRole</h2>

      <p>
        <strong>AWS STS(Security Token Service)</strong>는 IAM 역할을 사용할 때 핵심적인 서비스입니다.
        STS는 임시 보안 자격증명을 생성하고 관리하며, 이를 통해 역할을 "맡는(Assume)" 과정을 처리합니다.
      </p>

      <h3>4.1 STS의 주요 API</h3>

      <table>
        <thead>
          <tr>
            <th>API</th>
            <th>용도</th>
            <th>최대 세션 시간</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>AssumeRole</strong></td>
            <td>IAM 역할을 맡아 임시 자격증명 획득</td>
            <td>1시간 ~ 12시간</td>
          </tr>
          <tr>
            <td><strong>AssumeRoleWithSAML</strong></td>
            <td>SAML 인증 후 역할 맡기 (SSO)</td>
            <td>1시간 ~ 12시간</td>
          </tr>
          <tr>
            <td><strong>AssumeRoleWithWebIdentity</strong></td>
            <td>웹 자격증명(Cognito, Google 등) 후 역할 맡기</td>
            <td>1시간 ~ 12시간</td>
          </tr>
          <tr>
            <td><strong>GetSessionToken</strong></td>
            <td>IAM 사용자의 임시 자격증명 발급 (MFA 인증)</td>
            <td>15분 ~ 36시간</td>
          </tr>
          <tr>
            <td><strong>GetCallerIdentity</strong></td>
            <td>현재 자격증명의 정보 확인 (디버깅용)</td>
            <td>해당 없음</td>
          </tr>
        </tbody>
      </table>

      <h3>4.2 AssumeRole 동작 흐름</h3>

      <div class="diagram">
        <div class="diagram-title">AssumeRole 호출 흐름</div>
        <div class="diagram-row">
          <div class="diagram-box user">
            <div class="box-title">1. 호출자 (Caller)</div>
            <div class="box-sub">IAM 사용자, 역할, AWS 서비스</div>
          </div>
          <div class="diagram-arrow">&rarr; sts:AssumeRole</div>
          <div class="diagram-box security">
            <div class="box-title">2. AWS STS</div>
            <div class="box-sub">신뢰 정책 확인<br>호출자 권한 확인</div>
          </div>
        </div>
        <div class="diagram-arrow down">&darr; 검증 통과</div>
        <div class="diagram-row">
          <div class="diagram-box iam">
            <div class="box-title">3. 임시 자격증명 발급</div>
            <div class="box-sub">AccessKeyId + SecretAccessKey + SessionToken<br>만료 시간 포함</div>
          </div>
        </div>
        <div class="diagram-arrow down">&darr; 임시 자격증명 사용</div>
        <div class="diagram-row">
          <div class="diagram-box storage">
            <div class="box-title">4. AWS 리소스 접근</div>
            <div class="box-sub">역할의 권한 정책에 따라<br>S3, DynamoDB 등 접근</div>
          </div>
        </div>
      </div>

      <h3>4.3 AssumeRole 응답 구조</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Credentials": {
    "AccessKeyId": "ASIAIOSFODNN7EXAMPLE",
    "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYzEXAMPLEKEY",
    "SessionToken": "FwoGZXIvYXdzEBYaDH... (매우 긴 토큰)",
    "Expiration": "2026-02-20T15:30:00Z"
  },
  "AssumedRoleUser": {
    "AssumedRoleId": "AROA3XFRBF23GRDC3AEXE:shopeasy-session",
    "Arn": "arn:aws:sts::123456789012:assumed-role/shopeasy-api-role/shopeasy-session"
  },
  "PackedPolicySize": 6
}</code></pre>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">임시 자격증명의 3가지 요소</div>
        <p>
          STS가 발급하는 임시 자격증명은 3가지 요소로 구성됩니다:<br>
          <strong>1. AccessKeyId:</strong> <code>ASIA</code>로 시작 (장기 Key는 <code>AKIA</code>로 시작)<br>
          <strong>2. SecretAccessKey:</strong> 요청 서명에 사용<br>
          <strong>3. SessionToken:</strong> 임시 자격증명임을 증명하는 토큰 (반드시 함께 전송)<br><br>
          <code>ASIA</code>로 시작하는 Access Key를 보면 임시 자격증명임을 알 수 있습니다.
          <code>AKIA</code>로 시작하면 장기 자격증명이므로 유출 시 즉시 조치가 필요합니다.
        </p>
      </div>

      <h3>4.4 CLI에서 AssumeRole 사용</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 현재 자격증명 확인
aws sts get-caller-identity

# 역할 맡기 (AssumeRole)
aws sts assume-role \
  --role-arn "arn:aws:iam::123456789012:role/shopeasy-api-role" \
  --role-session-name "shopeasy-debug-session" \
  --duration-seconds 3600

# 반환된 임시 자격증명을 환경변수로 설정
export AWS_ACCESS_KEY_ID="ASIAIOSFODNN7EXAMPLE"
export AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYzEXAMPLEKEY"
export AWS_SESSION_TOKEN="FwoGZXIvYXdzEBYaDH..."

# 이제 역할의 권한으로 API 호출
aws s3 ls s3://shopeasy-product-images/
aws sts get-caller-identity  # assumed-role로 표시됨</code></pre>
      </div>

      <h3>4.5 AWS CLI 프로파일을 통한 자동 역할 전환</h3>

      <p>
        매번 환경변수를 설정하는 대신, <code>~/.aws/config</code>에 프로파일을 정의하면
        CLI가 자동으로 AssumeRole을 수행합니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">ini</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># ~/.aws/config

[profile default]
region = ap-northeast-2

[profile shopeasy-api]
role_arn = arn:aws:iam::123456789012:role/shopeasy-api-role
source_profile = default
region = ap-northeast-2
duration_seconds = 3600

[profile shopeasy-admin]
role_arn = arn:aws:iam::123456789012:role/shopeasy-admin-role
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/admin-user
region = ap-northeast-2</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 프로파일 지정으로 자동 AssumeRole
aws s3 ls --profile shopeasy-api

# MFA가 필요한 프로파일 (MFA 코드 입력 프롬프트 표시)
aws iam list-users --profile shopeasy-admin</code></pre>
      </div>

      <h3>4.6 임시 자격증명의 수명 관리</h3>

      <table>
        <thead>
          <tr>
            <th>시나리오</th>
            <th>기본 세션 시간</th>
            <th>최대 세션 시간</th>
            <th>설정 방법</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>AssumeRole (일반)</td>
            <td>1시간</td>
            <td>12시간</td>
            <td>역할의 MaxSessionDuration 설정</td>
          </tr>
          <tr>
            <td>EC2 인스턴스 프로파일</td>
            <td>6시간</td>
            <td>12시간</td>
            <td>자동 갱신 (SDK가 처리)</td>
          </tr>
          <tr>
            <td>Lambda 실행 역할</td>
            <td>함수 타임아웃과 동일</td>
            <td>15분</td>
            <td>Lambda 타임아웃 설정</td>
          </tr>
          <tr>
            <td>역할 체이닝</td>
            <td>1시간</td>
            <td>1시간 (제한)</td>
            <td>변경 불가</td>
          </tr>
          <tr>
            <td>콘솔 역할 전환</td>
            <td>1시간</td>
            <td>12시간</td>
            <td>역할의 MaxSessionDuration 설정</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box warning">
        <div class="info-box-title">역할 체이닝의 세션 시간 제한</div>
        <p>
          <strong>역할 체이닝(Role Chaining)</strong>은 역할 A를 맡은 상태에서 다시 역할 B를 맡는 것입니다.
          이 경우 세션 시간이 <strong>최대 1시간으로 제한</strong>됩니다 (MaxSessionDuration과 무관).
          장시간 작업이 필요한 경우 역할 체이닝을 피하고, 직접 대상 역할을 맡도록 설계해야 합니다.
        </p>
      </div>

      <h3>4.7 세션 정책 (Session Policy)</h3>

      <p>
        AssumeRole 호출 시 <strong>세션 정책</strong>을 전달하여 역할의 권한을 더 좁힐 수 있습니다.
        세션 정책은 역할의 권한 정책과의 <strong>교집합</strong>으로 적용됩니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 세션 정책을 포함한 AssumeRole
# 역할은 S3 전체 접근 권한이 있지만, 이 세션에서는 GetObject만 허용
aws sts assume-role \
  --role-arn "arn:aws:iam::123456789012:role/shopeasy-api-role" \
  --role-session-name "readonly-session" \
  --policy '{
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::shopeasy-product-images/*"
    }]
  }'</code></pre>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">세션 정책의 활용</div>
        <p>
          세션 정책은 다음과 같은 상황에서 유용합니다:<br>
          <strong>1. 읽기 전용 세션:</strong> 관리자 역할을 맡되, 특정 세션에서는 읽기만 허용<br>
          <strong>2. 특정 리소스 제한:</strong> 역할 자체는 모든 S3 버킷에 접근 가능하지만, 특정 세션에서는 하나의 버킷만 허용<br>
          <strong>3. 페더레이션 사용자 제한:</strong> 외부 사용자가 역할을 맡을 때 추가 제한 적용
        </p>
      </div>
    </section>

    <!-- ==================== 섹션 5: 크로스 계정 역할 전환 ==================== -->
    <section class="content-section" id="cross-account">
      <h2>5. 크로스 계정 역할 전환</h2>

      <p>
        AWS 멀티 계정 환경에서 <strong>계정 간 리소스 접근</strong>이 필요할 때 크로스 계정 역할을 사용합니다.
        예를 들어, ShopEasy의 개발 계정에서 운영 계정의 S3 버킷에 접근하거나,
        모니터링 계정에서 여러 계정의 CloudWatch 데이터를 수집할 때 활용됩니다.
      </p>

      <h3>5.1 크로스 계정 접근 구조</h3>

      <div class="diagram">
        <div class="diagram-title">크로스 계정 역할 전환 흐름</div>
        <div class="diagram-row" style="gap: 2rem;">
          <div class="diagram-group vpc" style="padding: 1.5rem; flex: 1;">
            <div class="diagram-group-label">계정 A (개발: 111111111111)</div>
            <div class="diagram-row">
              <div class="diagram-box user">
                <div class="box-title">IAM 사용자</div>
                <div class="box-sub">developer-kim</div>
              </div>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
              sts:AssumeRole 권한 필요
            </div>
          </div>
          <div style="display: flex; align-items: center; font-size: 1.5rem; color: var(--sec-red);">&rarr;</div>
          <div class="diagram-group security-layer" style="padding: 1.5rem; flex: 1;">
            <div class="diagram-group-label">계정 B (운영: 222222222222)</div>
            <div class="diagram-row">
              <div class="diagram-box iam">
                <div class="box-title">IAM 역할</div>
                <div class="box-sub">cross-account-role</div>
              </div>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-light);">
              신뢰 정책에 계정 A 허용
            </div>
          </div>
        </div>
      </div>

      <h3>5.2 크로스 계정 설정 (2단계)</h3>

      <p><strong>Step 1:</strong> 계정 B(운영)에서 역할 생성 &mdash; 신뢰 정책에 계정 A를 지정합니다.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// 계정 B(222222222222)에서 역할의 신뢰 정책
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111111111111:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "Bool": {
          "aws:MultiFactorAuthPresent": "true"
        }
      }
    }
  ]
}

// 계정 B의 역할에 부착할 권한 정책
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::shopeasy-production-data",
        "arn:aws:s3:::shopeasy-production-data/*"
      ]
    }
  ]
}</code></pre>
      </div>

      <p><strong>Step 2:</strong> 계정 A(개발)에서 사용자에게 AssumeRole 권한을 부여합니다.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// 계정 A(111111111111)에서 사용자의 권한 정책
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::222222222222:role/cross-account-role"
    }
  ]
}</code></pre>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">크로스 계정 접근의 양방향 승인</div>
        <p>
          크로스 계정 역할 전환은 <strong>양쪽 계정의 동의가 모두 필요</strong>합니다:<br>
          <strong>계정 B (리소스 소유자):</strong> "계정 A를 신뢰한다" (신뢰 정책)<br>
          <strong>계정 A (접근 요청자):</strong> "계정 B의 역할을 맡을 수 있다" (권한 정책)<br>
          어느 한쪽이라도 허용하지 않으면 접근이 거부됩니다.
        </p>
      </div>

      <h3>5.3 AWS 콘솔에서 역할 전환 (Switch Role)</h3>

      <p>
        AWS Management Console에서도 역할 전환이 가능합니다.
        우측 상단 계정 메뉴에서 "Switch Role"을 선택하여 다른 계정의 역할로 전환할 수 있습니다.
      </p>

      <table>
        <thead>
          <tr>
            <th>입력 항목</th>
            <th>값</th>
            <th>설명</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Account</td>
            <td>222222222222</td>
            <td>전환할 대상 계정 ID</td>
          </tr>
          <tr>
            <td>Role</td>
            <td>cross-account-role</td>
            <td>맡을 역할 이름</td>
          </tr>
          <tr>
            <td>Display Name</td>
            <td>ShopEasy-Production</td>
            <td>콘솔에 표시할 이름 (선택)</td>
          </tr>
          <tr>
            <td>Color</td>
            <td>빨강</td>
            <td>운영 계정은 빨간색으로 구분 (권장)</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box tip">
        <div class="info-box-title">콘솔 역할 전환의 색상 코딩 관례</div>
        <p>
          멀티 계정 환경에서 실수로 운영 계정에서 작업하는 것을 방지하기 위해 색상 코딩을 활용하세요:<br>
          <strong>빨강:</strong> 운영(Production) 계정 &mdash; 주의 필요<br>
          <strong>노랑:</strong> 스테이징(Staging) 계정<br>
          <strong>초록:</strong> 개발(Development) 계정<br>
          <strong>파랑:</strong> 보안/감사(Security/Audit) 계정
        </p>
      </div>

      <h3>5.4 ShopEasy 멀티 계정 역할 설계</h3>

      <div class="diagram">
        <div class="diagram-title">ShopEasy 멀티 계정 역할 전환 구조</div>
        <div class="diagram-row" style="gap: 1rem;">
          <div class="diagram-group vpc" style="padding: 1rem; flex: 1;">
            <div class="diagram-group-label">개발 계정</div>
            <div class="diagram-box user">
              <div class="box-title">개발자</div>
              <div class="box-sub">developer-kim<br>developer-lee</div>
            </div>
          </div>
          <div class="diagram-group security-layer" style="padding: 1rem; flex: 1;">
            <div class="diagram-group-label">운영 계정</div>
            <div class="diagram-box iam">
              <div class="box-title">ReadOnly Role</div>
              <div class="box-sub">로그, 메트릭 조회</div>
            </div>
            <div class="diagram-box security">
              <div class="box-title">Deploy Role</div>
              <div class="box-sub">배포 (MFA 필수)</div>
            </div>
          </div>
          <div class="diagram-group cloud" style="padding: 1rem; flex: 1;">
            <div class="diagram-group-label">보안 계정</div>
            <div class="diagram-box detective">
              <div class="box-title">Audit Role</div>
              <div class="box-sub">CloudTrail, Config 조회</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== 섹션 6: 실습 ==================== -->
    <section class="content-section" id="lab-roles">
      <h2>6. 실습: IAM 역할 & 임시 자격증명</h2>

      <p>
        이번 실습에서는 IAM 역할을 생성하고, EC2 인스턴스 프로파일을 설정하며,
        AssumeRole을 사용하여 임시 자격증명을 획득하는 과정을 진행합니다.
      </p>

      <div class="lab-section">
        <h3 class="lab-title">Lab 1: EC2 인스턴스 프로파일 설정</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: IAM 역할 생성</div>
            <p>ShopEasy API 서버용 IAM 역할을 생성합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 신뢰 정책 파일 생성
cat &gt; ec2-trust-policy.json &lt;&lt; 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
EOF

# IAM 역할 생성
aws iam create-role \
  --role-name shopeasy-api-role \
  --assume-role-policy-document file://ec2-trust-policy.json \
  --description "ShopEasy API 서버용 역할" \
  --max-session-duration 7200 \
  --tags Key=Project,Value=ShopEasy Key=Environment,Value=Production</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: 권한 정책 생성 및 연결</div>
            <p>API 서버에 필요한 최소 권한 정책을 생성하고 역할에 연결합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 권한 정책 파일 생성
cat &gt; shopeasy-api-policy.json &lt;&lt; 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "S3ProductImages",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::shopeasy-product-images/*"
    },
    {
      "Sid": "S3ListBucket",
      "Effect": "Allow",
      "Action": "s3:ListBucket",
      "Resource": "arn:aws:s3:::shopeasy-product-images"
    },
    {
      "Sid": "CloudWatchLogs",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:ap-northeast-2:*:log-group:/shopeasy/*"
    }
  ]
}
EOF

# 정책 생성
aws iam create-policy \
  --policy-name ShopEasyAPIPolicy \
  --policy-document file://shopeasy-api-policy.json

# 역할에 정책 연결
aws iam attach-role-policy \
  --role-name shopeasy-api-role \
  --policy-arn "arn:aws:iam::123456789012:policy/ShopEasyAPIPolicy"</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 3: 인스턴스 프로파일 생성 및 연결</div>
            <p>인스턴스 프로파일을 생성하고 역할을 연결합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 인스턴스 프로파일 생성
aws iam create-instance-profile \
  --instance-profile-name shopeasy-api-profile

# 역할을 인스턴스 프로파일에 추가
aws iam add-role-to-instance-profile \
  --instance-profile-name shopeasy-api-profile \
  --role-name shopeasy-api-role

# 확인
aws iam get-instance-profile \
  --instance-profile-name shopeasy-api-profile</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 4: EC2 인스턴스에 프로파일 연결</div>
            <p>실행 중인 EC2 인스턴스에 인스턴스 프로파일을 연결하고 IMDSv2를 강제합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 기존 인스턴스에 프로파일 연결
aws ec2 associate-iam-instance-profile \
  --instance-id i-0123456789abcdef0 \
  --iam-instance-profile Name=shopeasy-api-profile

# IMDSv2 강제 설정
aws ec2 modify-instance-metadata-options \
  --instance-id i-0123456789abcdef0 \
  --http-tokens required \
  --http-endpoint enabled \
  --http-put-response-hop-limit 1

# 연결 확인
aws ec2 describe-iam-instance-profile-associations \
  --filters "Name=instance-id,Values=i-0123456789abcdef0"</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 5: EC2 내부에서 자격증명 확인</div>
            <p>EC2에 SSH 접속 후 인스턴스 프로파일이 정상 작동하는지 확인합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># EC2 인스턴스 내부에서 실행

# 현재 자격증명 확인 (assumed-role/shopeasy-api-role 이 표시되어야 함)
aws sts get-caller-identity

# IMDSv2로 역할 이름 확인
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/

# S3 접근 테스트 (성공해야 함)
aws s3 ls s3://shopeasy-product-images/

# IAM 접근 테스트 (실패해야 함 - 최소 권한)
aws iam list-users
# 예상 결과: An error occurred (AccessDenied)</code></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="lab-section">
        <h3 class="lab-title">Lab 2: AssumeRole로 역할 전환</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: 전환 대상 역할 생성</div>
            <p>ShopEasy 관리자용 역할을 생성합니다. MFA 인증을 조건으로 설정합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># MFA 필수 신뢰 정책
cat &gt; admin-trust-policy.json &lt;&lt; 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "Bool": {
          "aws:MultiFactorAuthPresent": "true"
        }
      }
    }
  ]
}
EOF

# 관리자 역할 생성
aws iam create-role \
  --role-name shopeasy-admin-role \
  --assume-role-policy-document file://admin-trust-policy.json \
  --description "ShopEasy 관리자 역할 (MFA 필수)" \
  --max-session-duration 3600

# 관리자 권한 연결
aws iam attach-role-policy \
  --role-name shopeasy-admin-role \
  --policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: 사용자에게 AssumeRole 권한 부여</div>
            <p>개발자 사용자가 관리자 역할을 맡을 수 있는 권한을 부여합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># AssumeRole 권한 정책 생성
cat &gt; assume-admin-policy.json &lt;&lt; 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowAssumeAdminRole",
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::123456789012:role/shopeasy-admin-role"
    }
  ]
}
EOF

# 정책 생성 및 사용자에게 연결
aws iam create-policy \
  --policy-name AssumeAdminRolePolicy \
  --policy-document file://assume-admin-policy.json

aws iam attach-user-policy \
  --user-name developer-kim \
  --policy-arn "arn:aws:iam::123456789012:policy/AssumeAdminRolePolicy"</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 3: AssumeRole 실행 및 검증</div>
            <p>실제로 역할을 맡고 임시 자격증명을 사용합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 현재 자격증명 확인
aws sts get-caller-identity
# 출력: "Arn": "arn:aws:iam::123456789012:user/developer-kim"

# MFA 토큰으로 세션 토큰 발급
aws sts get-session-token \
  --serial-number "arn:aws:iam::123456789012:mfa/developer-kim" \
  --token-code 123456

# 발급된 세션 토큰으로 AssumeRole 실행
aws sts assume-role \
  --role-arn "arn:aws:iam::123456789012:role/shopeasy-admin-role" \
  --role-session-name "admin-session-kim" \
  --serial-number "arn:aws:iam::123456789012:mfa/developer-kim" \
  --token-code 654321 \
  --duration-seconds 3600

# 반환된 자격증명으로 환경변수 설정
export AWS_ACCESS_KEY_ID="ASIAEXAMPLEKEY"
export AWS_SECRET_ACCESS_KEY="EXAMPLESECRETKEY"
export AWS_SESSION_TOKEN="EXAMPLESESSIONTOKEN"

# 역할 전환 확인
aws sts get-caller-identity
# 출력: "Arn": "arn:aws:sts::123456789012:assumed-role/shopeasy-admin-role/admin-session-kim"

# 관리자 권한으로 IAM 사용자 목록 조회 (성공)
aws iam list-users</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 4: 세션 정보 확인 및 정리</div>
            <p>임시 자격증명의 만료 시간을 확인하고, 세션을 정리합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 환경변수 제거 (원래 자격증명으로 복귀)
unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
unset AWS_SESSION_TOKEN

# 원래 자격증명 확인
aws sts get-caller-identity
# 출력: "Arn": "arn:aws:iam::123456789012:user/developer-kim"</code></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="lab-section">
        <h3 class="lab-title">Lab 3: CloudTrail로 AssumeRole 이벤트 추적</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: AssumeRole 이벤트 조회</div>
            <p>CloudTrail에서 역할 전환 이벤트를 확인합니다. 누가, 언제, 어떤 역할을 맡았는지 추적할 수 있습니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># AssumeRole 이벤트 조회
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=AssumeRole \
  --start-time "2026-02-20T00:00:00Z" \
  --query "Events[].{
    Time: EventTime,
    User: Username,
    Role: Resources[0].ResourceName,
    SourceIP: CloudTrailEvent
  }" \
  --output table

# 특정 역할에 대한 AssumeRole 이벤트만 필터링
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=ResourceName,AttributeValue=shopeasy-admin-role \
  --query "Events[].{Time:EventTime,User:Username}" \
  --output table</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: 비정상 역할 전환 탐지</div>
            <p>
              예상치 못한 시간이나 IP에서의 역할 전환을 확인합니다.
              이 데이터를 기반으로 보안 알림을 설정할 수 있습니다.
            </p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 최근 24시간의 AssumeRole 이벤트에서 소스 IP 확인
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=AssumeRole \
  --start-time "$(date -u -v-1d '+%Y-%m-%dT%H:%M:%SZ')" \
  --query "Events[].[EventTime, Username]" \
  --output text

# 실패한 AssumeRole 시도 확인 (보안 감사)
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=AssumeRole \
  --start-time "2026-02-20T00:00:00Z" \
  --query "Events[?contains(CloudTrailEvent, '\"errorCode\"')]" \
  --output json</code></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="info-box best-practice">
        <div class="info-box-title">IAM 역할 & 임시 자격증명 핵심 정리</div>
        <p>
          1. <strong>Access Key 대신 역할 사용:</strong> EC2, Lambda, ECS 등 모든 AWS 서비스에서 역할(임시 자격증명)을 사용하세요<br>
          2. <strong>IMDSv2 강제:</strong> 모든 EC2 인스턴스에서 IMDSv2를 필수로 설정하세요<br>
          3. <strong>최소 세션 시간:</strong> 필요한 만큼만 세션 시간을 설정하세요 (기본 1시간 권장)<br>
          4. <strong>MFA 조건:</strong> 민감한 역할의 신뢰 정책에 MFA 조건을 추가하세요<br>
          5. <strong>ExternalId:</strong> 서드파티 서비스와 연동할 때 반드시 ExternalId를 설정하세요<br>
          6. <strong>역할 체이닝 주의:</strong> 역할 체이닝은 1시간 제한이 있으므로, 직접 역할을 맡도록 설계하세요<br>
          7. <strong>CloudTrail 모니터링:</strong> AssumeRole 이벤트를 정기적으로 모니터링하세요<br>
          8. <strong>세션 이름에 의미 부여:</strong> role-session-name에 사용자/용도를 명시하여 감사를 용이하게 하세요
        </p>
      </div>
    </section>

    <div class="chapter-nav">
      <a href="03-iam-policy-deep-dive.html" class="prev">이전: IAM 정책 언어 심화</a>
      <a href="05-permission-boundary.html" class="next">다음: 권한 경계 & 최소 권한 설계</a>
    </div>
  </main>
</div>

<script type="module" src="../assets/js/main.js"></script>
</body>

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/04-iam-roles-sts.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
</html>
