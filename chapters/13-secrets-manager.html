<!DOCTYPE html>
<html lang="ko">

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/13-secrets-manager.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secrets Manager & Parameter Store - AWS 클라우드 보안</title>
  <link href="../../cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>

<header class="site-header">
  <div class="header-inner">
    <a href="../index-2.html" class="header-logo">
      <span class="aws-icon">&#x1F6E1; AWS Security</span>
      <span>클라우드 보안 강의</span>
    </a>
  </div>
</header>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li class="sidebar-section">데이터 보호</li>
      <li><a href="#hardcoded-secrets">하드코딩된 비밀번호의 위험</a></li>
      <li><a href="#secrets-manager">Secrets Manager 개요</a></li>
      <li><a href="#secrets-manager-db">DB 비밀번호 관리</a></li>
      <li><a href="#auto-rotation">자동 로테이션 설정</a></li>
      <li><a href="#parameter-store">Parameter Store 개요</a></li>
      <li><a href="#comparison">SM vs PS 비교</a></li>
      <li class="sidebar-section">실습</li>
      <li><a href="#lab-a">실습 A: DB 비밀번호 저장</a></li>
      <li><a href="#lab-b">실습 B: ShopEasy 전환</a></li>
    </ul>
  </nav>

  <main class="main-content">
    <div class="chapter-header">
      <span class="chapter-num">Chapter 13</span>
      <h1>Secrets Manager & Parameter Store</h1>
      <div class="objectives">
        <h3>학습 목표</h3>
        <ul>
          <li>코드에 비밀번호를 하드코딩하면 발생하는 보안 위험을 이해한다</li>
          <li>AWS Secrets Manager를 사용하여 보안 정보를 안전하게 저장하고 조회할 수 있다</li>
          <li>자동 로테이션을 설정하여 비밀번호를 주기적으로 변경할 수 있다</li>
          <li>Parameter Store와 Secrets Manager의 차이점을 이해하고 적절히 선택할 수 있다</li>
          <li>ShopEasy 앱의 .env 파일을 Secrets Manager로 전환할 수 있다</li>
        </ul>
      </div>
    </div>

    <!-- Section 1: 하드코딩된 비밀번호의 위험 -->
    <section class="content-section" id="hardcoded-secrets">
      <h2>1. 하드코딩된 비밀번호의 위험</h2>

      <div class="info-box analogy">
        <div class="info-box-title">비유: 열쇠를 현관 매트 아래에 두는 것</div>
        <p>집 열쇠를 현관 매트 아래에 숨겨두면 어떻게 될까요? 누구나 매트를 들어보면 열쇠를 찾을 수 있습니다. 코드에 비밀번호를 직접 넣는 것도 같습니다. 코드에 접근할 수 있는 <strong>누구나</strong> 비밀번호를 볼 수 있고, 한번 노출되면 되돌릴 수 없습니다.</p>
        <p>비밀번호 관리 서비스는 마치 <strong>금고</strong>와 같습니다. 열쇠(비밀번호)를 금고에 보관하고, 필요할 때만 본인 인증을 거쳐 꺼내 쓰는 방식입니다.</p>
      </div>

      <h3>코드에 비밀번호를 직접 넣으면 생기는 문제</h3>

      <p>개발 초기 단계에서 많은 개발자들이 편의상 코드에 직접 비밀번호나 API 키를 작성합니다. 이것은 매우 위험한 습관입니다.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">javascript</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// ShopEasy의 server.js - 절대 이렇게 하면 안 됩니다!
const mysql = require('mysql2');

const connection = mysql.createConnection({
  host: 'shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com',
  user: 'admin',
  password: 'SuperSecret123!',   // 비밀번호 하드코딩
  database: 'shopeasy'
});

// AWS S3 접근키도 하드코딩
const AWS = require('aws-sdk');
AWS.config.update({
  accessKeyId: 'AKIAIOSFODNN7EXAMPLE',      // AWS Access Key
  secretAccessKey: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'  // Secret Key
});</code></pre>
      </div>

      <div class="info-box danger">
        <div class="info-box-title">위험: 하드코딩의 5가지 문제점</div>
        <ul>
          <li><strong>소스 코드 노출</strong> - 코드가 유출되면 모든 비밀정보도 함께 노출됩니다</li>
          <li><strong>Git 히스토리</strong> - 한번이라도 커밋하면 히스토리에 영구적으로 남습니다</li>
          <li><strong>접근 범위 확대</strong> - 코드를 볼 수 있는 모든 사람이 비밀번호를 알게 됩니다</li>
          <li><strong>비밀번호 변경 어려움</strong> - 비밀번호를 바꾸려면 코드를 수정하고 재배포해야 합니다</li>
          <li><strong>환경별 관리 불가</strong> - 개발/스테이징/운영 환경별로 다른 비밀번호를 관리할 수 없습니다</li>
        </ul>
      </div>

      <h3>Git 커밋 히스토리에 남는 비밀번호</h3>

      <p>가장 심각한 문제 중 하나는 Git 히스토리입니다. 비밀번호를 코드에서 지우더라도 이전 커밋에는 그대로 남아있습니다.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 과거 커밋에서 비밀번호 검색 - 삭제해도 찾을 수 있습니다!
git log -p --all -S 'SuperSecret123!'

# 결과:
# commit a1b2c3d4...
# Author: developer@shopeasy.com
# Date: Mon Jan 15 09:30:00 2024
#
#   Add database connection
#
# +  password: 'SuperSecret123!',</code></pre>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">주의: Git 히스토리에서 비밀번호를 완전히 제거하려면</div>
        <p><code>git filter-branch</code> 또는 <code>BFG Repo-Cleaner</code> 같은 도구로 히스토리를 재작성해야 합니다. 이 과정은 복잡하고, 이미 다른 사람이 clone 했다면 완전한 제거가 불가능합니다. <strong>처음부터 비밀번호를 커밋하지 않는 것이 최선</strong>입니다.</p>
      </div>

      <h3>.env 파일의 한계</h3>

      <p>많은 개발자들이 .env 파일을 사용하여 비밀번호를 관리합니다. 이것은 하드코딩보다 낫지만 여전히 한계가 있습니다.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># ShopEasy .env 파일 예시
DB_HOST=shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com
DB_USER=admin
DB_PASSWORD=SuperSecret123!
DB_NAME=shopeasy
JWT_SECRET=my-jwt-secret-key-2024
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
S3_BUCKET=shopeasy-product-images</code></pre>
      </div>

      <table>
        <thead>
          <tr>
            <th>항목</th>
            <th>.env 파일</th>
            <th>Secrets Manager</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>저장 위치</td>
            <td>서버 파일시스템 (평문)</td>
            <td>AWS 관리형 암호화 저장소</td>
          </tr>
          <tr>
            <td>암호화</td>
            <td>없음 (평문 텍스트)</td>
            <td>KMS로 암호화</td>
          </tr>
          <tr>
            <td>접근 제어</td>
            <td>파일 권한(OS 수준)</td>
            <td>IAM 정책으로 세밀한 제어</td>
          </tr>
          <tr>
            <td>비밀번호 변경</td>
            <td>파일 수정 + 앱 재시작</td>
            <td>자동 로테이션 가능</td>
          </tr>
          <tr>
            <td>감사 로그</td>
            <td>없음</td>
            <td>CloudTrail로 모든 접근 기록</td>
          </tr>
          <tr>
            <td>환경별 관리</td>
            <td>서버마다 별도 파일</td>
            <td>이름 규칙으로 통합 관리</td>
          </tr>
          <tr>
            <td>백업</td>
            <td>직접 관리</td>
            <td>자동 버전 관리</td>
          </tr>
        </tbody>
      </table>

      <h3>실제 보안 사고 사례</h3>

      <div class="info-box danger">
        <div class="info-box-title">실제 사례: GitHub에 AWS 키 노출</div>
        <p>GitHub에 AWS Access Key가 노출되는 사고는 매년 빈번하게 발생합니다. 봇(Bot)이 공개 저장소를 실시간으로 스캔하며, <strong>AWS 키가 커밋되면 수 분 내에 악용</strong>됩니다.</p>
        <ul>
          <li>한 스타트업 개발자가 실수로 AWS 키를 public 저장소에 push 했습니다</li>
          <li>3분 만에 봇이 키를 탐지하고 EC2 인스턴스를 수백 개 생성했습니다</li>
          <li>하룻밤 사이에 <strong>$15,000 이상의 요금</strong>이 청구되었습니다</li>
          <li>비트코인 채굴에 사용된 것으로 확인되었습니다</li>
        </ul>
      </div>

      <div class="info-box danger">
        <div class="info-box-title">실제 사례: Uber 데이터 유출 (2016)</div>
        <p>Uber 개발자들이 GitHub 비공개 저장소에 AWS 자격 증명을 저장했는데, 해커가 이를 탈취하여 <strong>5,700만 명의 개인정보</strong>가 유출되었습니다. Uber는 이 사건을 1년 이상 은폐했고, 결국 $148M의 합의금을 지불했습니다.</p>
      </div>

      <div class="info-box best-practice">
        <div class="info-box-title">Best Practice: 비밀번호 관리 원칙</div>
        <ul>
          <li><strong>.gitignore에 .env 추가</strong> - 최소한 이것은 반드시 해야 합니다</li>
          <li><strong>git-secrets 도구 사용</strong> - AWS 키 패턴을 감지하여 커밋을 차단합니다</li>
          <li><strong>Secrets Manager 사용</strong> - 운영 환경에서는 반드시 전용 서비스를 사용하세요</li>
          <li><strong>IAM Role 사용</strong> - EC2에서는 Access Key 대신 IAM Role을 사용하세요</li>
          <li><strong>주기적 비밀번호 변경</strong> - 자동 로테이션을 설정하세요</li>
        </ul>
      </div>
    </section>

    <!-- Section 2: Secrets Manager 개요 -->
    <section class="content-section" id="secrets-manager">
      <h2>2. AWS Secrets Manager 개요</h2>

      <div class="info-box concept">
        <div class="info-box-title">핵심 개념: AWS Secrets Manager</div>
        <p>AWS Secrets Manager는 애플리케이션에서 사용하는 비밀정보(비밀번호, API 키, 토큰 등)를 <strong>안전하게 저장, 관리, 검색</strong>할 수 있는 완전관리형 서비스입니다. 코드에서 하드코딩된 자격 증명을 제거하고, 런타임에 Secrets Manager API를 호출하여 비밀정보를 가져옵니다.</p>
      </div>

      <div class="diagram">
        <div class="diagram-title">Secrets Manager 동작 흐름</div>
        <div class="diagram-row">
          <div class="diagram-box compute">
            <div class="box-title">ShopEasy App</div>
            <div class="box-sub">EC2 / Lambda</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box encryption">
            <div class="box-title">Secrets Manager</div>
            <div class="box-sub">GetSecretValue API</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box security">
            <div class="box-title">KMS</div>
            <div class="box-sub">복호화 처리</div>
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box iam">
            <div class="box-title">IAM Role</div>
            <div class="box-sub">접근 권한 확인</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box detective">
            <div class="box-title">CloudTrail</div>
            <div class="box-sub">접근 기록 감사</div>
          </div>
        </div>
      </div>

      <h3>주요 기능</h3>

      <table>
        <thead>
          <tr>
            <th>기능</th>
            <th>설명</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>암호화 저장</td>
            <td>AWS KMS를 사용하여 보안 정보를 암호화합니다. 기본 aws/secretsmanager 키 또는 CMK 사용 가능</td>
          </tr>
          <tr>
            <td>자동 로테이션</td>
            <td>Lambda 함수를 이용하여 비밀번호를 자동으로 변경합니다 (RDS 기본 지원)</td>
          </tr>
          <tr>
            <td>버전 관리</td>
            <td>AWSCURRENT, AWSPREVIOUS 등 스테이징 레이블로 버전을 관리합니다</td>
          </tr>
          <tr>
            <td>접근 제어</td>
            <td>IAM 정책과 리소스 기반 정책으로 세밀한 접근 제어가 가능합니다</td>
          </tr>
          <tr>
            <td>감사 추적</td>
            <td>CloudTrail을 통해 누가, 언제 비밀정보에 접근했는지 기록됩니다</td>
          </tr>
          <tr>
            <td>교차 리전 복제</td>
            <td>다른 리전에 시크릿을 자동으로 복제하여 재해 복구에 활용합니다</td>
          </tr>
        </tbody>
      </table>

      <h3>지원하는 보안 정보 유형</h3>

      <ul>
        <li><strong>데이터베이스 자격증명</strong> - RDS, Aurora, Redshift, DocumentDB 등의 사용자명/비밀번호</li>
        <li><strong>API 키</strong> - 외부 서비스(Stripe, SendGrid, Slack 등)의 API 키</li>
        <li><strong>OAuth 토큰</strong> - 소셜 로그인(Google, Kakao) OAuth 클라이언트 시크릿</li>
        <li><strong>SSH 키</strong> - 서버 접속용 SSH 개인키</li>
        <li><strong>TLS 인증서</strong> - 사설 인증서의 개인키</li>
        <li><strong>커스텀 키-값</strong> - 어떤 텍스트/바이너리 데이터든 저장 가능 (최대 64KB)</li>
      </ul>

      <h3>비용 구조</h3>

      <table>
        <thead>
          <tr><th>항목</th><th>비용</th><th>비고</th></tr>
        </thead>
        <tbody>
          <tr><td>시크릿 저장</td><td>$0.40/월/시크릿</td><td>시크릿 1개당 월 비용</td></tr>
          <tr><td>API 호출</td><td>$0.05/10,000건</td><td>GetSecretValue 등</td></tr>
          <tr><td>자동 로테이션</td><td>추가 비용 없음</td><td>Lambda 실행 비용은 별도</td></tr>
        </tbody>
      </table>

      <div class="info-box tip">
        <div class="info-box-title">비용 최적화 팁</div>
        <p>시크릿 값을 JSON 형식으로 여러 키-값을 하나의 시크릿에 저장하면 비용을 절약할 수 있습니다. 예를 들어 DB 접속 정보(호스트, 포트, 사용자, 비밀번호)를 하나의 시크릿에 JSON으로 저장하세요.</p>
      </div>
    </section>

    <!-- Section 3: DB 비밀번호 관리 -->
    <section class="content-section" id="secrets-manager-db">
      <h2>3. Secrets Manager로 DB 비밀번호 관리</h2>

      <h3>시크릿 생성 (AWS CLI)</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 1. RDS 데이터베이스 비밀번호 저장
aws secretsmanager create-secret \
  --name "shopeasy/prod/db-credentials" \
  --description "ShopEasy 운영 DB 접속 정보" \
  --secret-string '{
    "username": "admin",
    "password": "SuperSecret123!",
    "engine": "mysql",
    "host": "shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com",
    "port": 3306,
    "dbname": "shopeasy"
  }'

# 2. API 키 저장
aws secretsmanager create-secret \
  --name "shopeasy/prod/stripe-api-key" \
  --description "ShopEasy Stripe 결제 API 키" \
  --secret-string '{
    "publishable_key": "pk_live_xxxxxxxxxxxx",
    "secret_key": "sk_live_xxxxxxxxxxxx"
  }'

# 3. 시크릿 조회
aws secretsmanager get-secret-value \
  --secret-id "shopeasy/prod/db-credentials"

# 4. 시크릿 업데이트
aws secretsmanager update-secret \
  --secret-id "shopeasy/prod/db-credentials" \
  --secret-string '{
    "username": "admin",
    "password": "NewPassword456!",
    "engine": "mysql",
    "host": "shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com",
    "port": 3306,
    "dbname": "shopeasy"
  }'

# 5. 시크릿 목록 조회
aws secretsmanager list-secrets \
  --filters Key=name,Values=shopeasy</code></pre>
      </div>

      <h3>Node.js SDK를 통한 시크릿 조회</h3>

      <div class="info-box tip">
        <div class="info-box-title">팁: SDK 캐싱</div>
        <p>매번 API를 호출하면 지연 시간과 비용이 발생합니다. 시크릿 값을 메모리에 캐싱하되, 로테이션 주기보다 짧은 TTL(예: 5분)을 설정하세요. AWS에서 제공하는 <code>aws-secretsmanager-caching</code> 라이브러리를 사용할 수도 있습니다.</p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">javascript</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>// Node.js - AWS SDK v3을 사용한 시크릿 조회 (캐싱 포함)
const { SecretsManagerClient, GetSecretValueCommand } = require('@aws-sdk/client-secrets-manager');

const client = new SecretsManagerClient({ region: 'ap-northeast-2' });

// 시크릿 캐싱
const secretCache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5분

async function getSecret(secretName) {
  // 캐시 확인
  const cached = secretCache.get(secretName);
  if (cached && Date.now() < cached.expiry) {
    return cached.value;
  }

  try {
    const command = new GetSecretValueCommand({ SecretId: secretName });
    const response = await client.send(command);
    const secret = JSON.parse(response.SecretString);

    // 캐시에 저장
    secretCache.set(secretName, {
      value: secret,
      expiry: Date.now() + CACHE_TTL
    });

    return secret;
  } catch (error) {
    console.error('시크릿 조회 실패:', error.message);
    throw error;
  }
}

// ShopEasy에서 DB 연결 시 사용
async function connectDatabase() {
  const dbSecret = await getSecret('shopeasy/prod/db-credentials');

  const pool = mysql.createPool({
    host: dbSecret.host,
    user: dbSecret.username,
    password: dbSecret.password,
    database: dbSecret.dbname,
    port: dbSecret.port,
    waitForConnections: true,
    connectionLimit: 10
  });

  return pool;
}</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">python</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># Python - boto3를 사용한 시크릿 조회
import json
import boto3
from botocore.exceptions import ClientError

def get_secret(secret_name, region_name='ap-northeast-2'):
    """AWS Secrets Manager에서 시크릿을 조회합니다."""
    client = boto3.client('secretsmanager', region_name=region_name)

    try:
        response = client.get_secret_value(SecretId=secret_name)
        secret = json.loads(response['SecretString'])
        return secret
    except ClientError as e:
        error_code = e.response['Error']['Code']
        if error_code == 'ResourceNotFoundException':
            print(f"시크릿 '{secret_name}'을 찾을 수 없습니다.")
        elif error_code == 'AccessDeniedException':
            print(f"시크릿 '{secret_name}'에 대한 접근 권한이 없습니다.")
        raise

# ShopEasy DB 연결
import pymysql
db_secret = get_secret('shopeasy/prod/db-credentials')
connection = pymysql.connect(
    host=db_secret['host'],
    user=db_secret['username'],
    password=db_secret['password'],
    database=db_secret['dbname'],
    port=db_secret['port']
)</code></pre>
      </div>
    </section>

    <!-- Section 4: 자동 로테이션 설정 -->
    <section class="content-section" id="auto-rotation">
      <h2>4. 자동 로테이션 설정</h2>

      <div class="info-box concept">
        <div class="info-box-title">핵심 개념: 비밀번호 자동 로테이션</div>
        <p>비밀번호를 오래 사용하면 탈취될 위험이 높아집니다. <strong>자동 로테이션</strong>은 Lambda 함수를 통해 비밀번호를 주기적으로 자동 변경하는 기능입니다. 비밀번호가 변경되어도 애플리케이션은 항상 Secrets Manager에서 최신 비밀번호를 가져오므로 중단 없이 작동합니다.</p>
      </div>

      <div class="diagram">
        <div class="diagram-title">비밀번호 자동 로테이션 프로세스 (4단계)</div>
        <div class="diagram-row">
          <div class="diagram-box monitor">
            <div class="box-title">1. createSecret</div>
            <div class="box-sub">새 비밀번호 생성, AWSPENDING 레이블</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box database">
            <div class="box-title">2. setSecret</div>
            <div class="box-sub">DB에 새 비밀번호 설정</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box compute">
            <div class="box-title">3. testSecret</div>
            <div class="box-sub">새 비밀번호로 접속 테스트</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box encryption">
            <div class="box-title">4. finishSecret</div>
            <div class="box-sub">AWSCURRENT로 변경</div>
          </div>
        </div>
      </div>

      <h3>로테이션 아키텍처</h3>

      <div class="diagram">
        <div class="diagram-title">Lambda 기반 로테이션 아키텍처</div>
        <div class="diagram-row">
          <div class="diagram-box security">
            <div class="box-title">Secrets Manager</div>
            <div class="box-sub">로테이션 트리거</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box serverless">
            <div class="box-title">Lambda 함수</div>
            <div class="box-sub">로테이션 로직 실행</div>
          </div>
          <div class="diagram-arrow">&rarr;</div>
          <div class="diagram-box database">
            <div class="box-title">RDS MySQL</div>
            <div class="box-sub">비밀번호 변경</div>
          </div>
        </div>
        <div class="diagram-row">
          <div class="diagram-box compute">
            <div class="box-title">ShopEasy App</div>
            <div class="box-sub">캐시 만료 후 새 비밀번호 사용</div>
          </div>
          <div class="diagram-arrow">&larr;</div>
          <div class="diagram-box security">
            <div class="box-title">Secrets Manager</div>
            <div class="box-sub">AWSCURRENT 비밀번호 반환</div>
          </div>
        </div>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">팁: 단일 사용자 vs 교대 사용자 로테이션</div>
        <ul>
          <li><strong>단일 사용자(Single User)</strong> - 하나의 DB 사용자 비밀번호를 직접 변경합니다. 로테이션 중 짧은 시간 동안 접속 실패 가능성이 있습니다.</li>
          <li><strong>교대 사용자(Alternating User)</strong> - 두 개의 DB 사용자를 번갈아 사용합니다. 한 사용자의 비밀번호를 변경하는 동안 다른 사용자로 접속하므로 <strong>다운타임이 없습니다</strong>. 운영 환경에 권장됩니다.</li>
        </ul>
      </div>

      <h3>RDS 비밀번호 자동 로테이션 설정</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 1. 자동 로테이션 활성화 (콘솔에서 하는 것을 권장)
aws secretsmanager rotate-secret \
  --secret-id "shopeasy/prod/db-credentials" \
  --rotation-lambda-arn "arn:aws:lambda:ap-northeast-2:123456789012:function:SecretsManagerRDSMySQLRotation" \
  --rotation-rules '{"ScheduleExpression": "rate(30 days)"}'

# 2. 즉시 로테이션 실행 (테스트 목적)
aws secretsmanager rotate-secret \
  --secret-id "shopeasy/prod/db-credentials"

# 3. 로테이션 상태 확인
aws secretsmanager describe-secret \
  --secret-id "shopeasy/prod/db-credentials" \
  --query '{RotationEnabled: RotationEnabled, RotationLambda: RotationLambdaARN, LastRotated: LastRotatedDate, NextRotation: NextRotationDate}'</code></pre>
      </div>

      <h3>로테이션 주기 설정</h3>

      <table>
        <thead>
          <tr><th>주기</th><th>설정 값</th><th>적합한 환경</th></tr>
        </thead>
        <tbody>
          <tr><td>매일</td><td><code>rate(1 day)</code></td><td>최고 보안 요구 환경</td></tr>
          <tr><td>7일</td><td><code>rate(7 days)</code></td><td>높은 보안 요구 환경</td></tr>
          <tr><td>30일</td><td><code>rate(30 days)</code></td><td>일반적인 운영 환경 (권장)</td></tr>
          <tr><td>90일</td><td><code>rate(90 days)</code></td><td>규정 준수 최소 요건</td></tr>
          <tr><td>cron 표현식</td><td><code>cron(0 4 1 * ? *)</code></td><td>매월 1일 새벽 4시</td></tr>
        </tbody>
      </table>

      <h3>로테이션 Lambda 함수 핵심 로직</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">python</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># 로테이션 Lambda 함수의 핵심 로직 (간소화 버전)
import boto3
import json
import pymysql
import string
import random

def lambda_handler(event, context):
    """Secrets Manager 로테이션 핸들러"""
    secret_id = event['SecretId']
    step = event['Step']      # createSecret, setSecret, testSecret, finishSecret
    token = event['ClientRequestToken']

    sm_client = boto3.client('secretsmanager')

    if step == 'createSecret':
        # 새 비밀번호 생성
        current = json.loads(
            sm_client.get_secret_value(SecretId=secret_id, VersionStage='AWSCURRENT')['SecretString']
        )
        new_password = generate_password(20)
        current['password'] = new_password
        sm_client.put_secret_value(
            SecretId=secret_id,
            ClientRequestToken=token,
            SecretString=json.dumps(current),
            VersionStages=['AWSPENDING']
        )

    elif step == 'setSecret':
        # DB에 새 비밀번호 적용
        pending = json.loads(
            sm_client.get_secret_value(SecretId=secret_id, VersionStage='AWSPENDING',
                                        VersionId=token)['SecretString']
        )
        # 현재 비밀번호로 DB에 접속하여 비밀번호 변경
        conn = pymysql.connect(host=pending['host'], user=pending['username'],
                                password=current_password, database=pending['dbname'])
        with conn.cursor() as cur:
            cur.execute(f"ALTER USER '{pending['username']}'@'%' IDENTIFIED BY '{pending['password']}'")
        conn.close()

    elif step == 'testSecret':
        # 새 비밀번호로 접속 테스트
        pending = json.loads(
            sm_client.get_secret_value(SecretId=secret_id, VersionStage='AWSPENDING',
                                        VersionId=token)['SecretString']
        )
        conn = pymysql.connect(host=pending['host'], user=pending['username'],
                                password=pending['password'], database=pending['dbname'])
        conn.close()

    elif step == 'finishSecret':
        # AWSPENDING -> AWSCURRENT로 변경
        sm_client.update_secret_version_stage(
            SecretId=secret_id, VersionStage='AWSCURRENT',
            MoveToVersionId=token, RemoveFromVersionId=current_version_id
        )

def generate_password(length=20):
    chars = string.ascii_letters + string.digits + '!@#$%'
    return ''.join(random.SystemRandom().choice(chars) for _ in range(length))</code></pre>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">주의: 로테이션 시 주의사항</div>
        <ul>
          <li><strong>Lambda VPC 설정</strong> - 로테이션 Lambda가 RDS에 접근하려면 같은 VPC에 배치하거나 VPC 엔드포인트를 설정해야 합니다</li>
          <li><strong>보안 그룹</strong> - Lambda의 보안 그룹에서 RDS 포트(3306)로의 아웃바운드가 허용되어야 합니다</li>
          <li><strong>Secrets Manager 엔드포인트</strong> - VPC 내 Lambda가 Secrets Manager에 접근하려면 VPC 엔드포인트 또는 NAT Gateway가 필요합니다</li>
          <li><strong>애플리케이션 캐싱</strong> - 앱에서 DB 연결을 캐싱하고 있다면, 로테이션 후 재연결 로직이 필요합니다</li>
        </ul>
      </div>
    </section>

    <!-- Section 5: Parameter Store 개요 -->
    <section class="content-section" id="parameter-store">
      <h2>5. Parameter Store 개요</h2>

      <div class="info-box concept">
        <div class="info-box-title">핵심 개념: SSM Parameter Store</div>
        <p>AWS Systems Manager Parameter Store는 설정 데이터와 보안 정보를 계층적으로 관리할 수 있는 서비스입니다. Secrets Manager보다 <strong>단순하고 비용 효율적</strong>이며, 비밀번호뿐만 아니라 일반 설정값(URL, 포트, 플래그 등)도 관리할 수 있습니다.</p>
      </div>

      <h3>파라미터 유형</h3>

      <table>
        <thead>
          <tr><th>파라미터 유형</th><th>암호화</th><th>사용 사례</th></tr>
        </thead>
        <tbody>
          <tr><td>String</td><td>없음</td><td>일반 설정값 (URL, 포트 등)</td></tr>
          <tr><td>StringList</td><td>없음</td><td>쉼표로 구분된 값 목록</td></tr>
          <tr><td><strong>SecureString</strong></td><td><strong>KMS 암호화</strong></td><td>비밀번호, API 키 등 민감 데이터</td></tr>
        </tbody>
      </table>

      <h3>Standard vs Advanced 티어</h3>

      <table>
        <thead>
          <tr><th>항목</th><th>Standard</th><th>Advanced</th></tr>
        </thead>
        <tbody>
          <tr><td>파라미터 수</td><td>10,000개</td><td>100,000개</td></tr>
          <tr><td>값 크기</td><td>4KB</td><td>8KB</td></tr>
          <tr><td>파라미터 정책</td><td>미지원</td><td>지원 (만료, 알림)</td></tr>
          <tr><td>비용</td><td><strong>무료</strong></td><td>$0.05/월/파라미터</td></tr>
          <tr><td>처리량</td><td>기본 40 TPS</td><td>높은 처리량 옵션</td></tr>
        </tbody>
      </table>

      <h3>계층적 파라미터 구성</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">bash</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code># ShopEasy 파라미터 계층 구조
# /shopeasy/
#   +-- prod/
#   |   +-- db-host          (String)
#   |   +-- db-port          (String)
#   |   +-- db-password      (SecureString)
#   |   +-- jwt-secret       (SecureString)
#   |   +-- s3-bucket        (String)
#   +-- dev/
#       +-- db-host          (String)
#       +-- db-password      (SecureString)

# SecureString 파라미터 생성 (KMS 기본 키 사용)
aws ssm put-parameter \
  --name "/shopeasy/prod/db-password" \
  --value "SuperSecret123!" \
  --type "SecureString" \
  --description "ShopEasy DB 비밀번호"

# CMK(Customer Managed Key) 사용
aws ssm put-parameter \
  --name "/shopeasy/prod/jwt-secret" \
  --value "my-jwt-secret-key" \
  --type "SecureString" \
  --key-id "alias/shopeasy-key"

# 경로별 파라미터 일괄 조회
aws ssm get-parameters-by-path \
  --path "/shopeasy/prod" \
  --with-decryption \
  --recursive</code></pre>
      </div>

      <h3>Node.js에서 Parameter Store 사용</h3>

      <div class="code-block">
        <div class="code-header">
          <span class="lang">javascript</span>
          <button class="copy-btn">복사</button>
        </div>
        <pre><code>const { SSMClient, GetParametersByPathCommand } = require('@aws-sdk/client-ssm');

const ssmClient = new SSMClient({ region: 'ap-northeast-2' });

// 경로 기반 일괄 조회
async function getParameters(path) {
  const params = {};
  let nextToken;

  do {
    const command = new GetParametersByPathCommand({
      Path: path,
      WithDecryption: true,
      Recursive: true,
      NextToken: nextToken
    });
    const response = await ssmClient.send(command);

    for (const param of response.Parameters) {
      const key = param.Name.split('/').pop();
      params[key] = param.Value;
    }
    nextToken = response.NextToken;
  } while (nextToken);

  return params;
}

// 사용 예시
const config = await getParameters('/shopeasy/prod');
// { 'db-host': '...', 'db-port': '3306', 's3-bucket': '...' }</code></pre>
      </div>
    </section>

    <!-- Section 6: 비교 -->
    <section class="content-section" id="comparison">
      <h2>6. Secrets Manager vs Parameter Store 비교</h2>

      <table>
        <thead>
          <tr>
            <th>비교 항목</th>
            <th>Secrets Manager</th>
            <th>Parameter Store</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>주요 목적</td>
            <td>비밀 정보 관리 전용</td>
            <td>구성 + 비밀 정보 범용</td>
          </tr>
          <tr>
            <td>비용</td>
            <td>$0.40/시크릿/월 + API 비용</td>
            <td><strong>Standard 무료</strong> / Advanced $0.05/파라미터/월</td>
          </tr>
          <tr>
            <td>자동 로테이션</td>
            <td><strong>내장 자동 로테이션 지원</strong></td>
            <td>없음 (직접 구현 필요)</td>
          </tr>
          <tr>
            <td>RDS 통합</td>
            <td><strong>RDS 비밀번호 로테이션 기본 지원</strong></td>
            <td>없음</td>
          </tr>
          <tr>
            <td>교차 계정 접근</td>
            <td><strong>리소스 기반 정책 지원</strong></td>
            <td>리소스 기반 정책 없음</td>
          </tr>
          <tr>
            <td>최대 크기</td>
            <td>64KB</td>
            <td>Standard 4KB / Advanced 8KB</td>
          </tr>
          <tr>
            <td>계층 구조</td>
            <td>이름 규칙으로 구현 (/ 구분자)</td>
            <td><strong>15 레벨 깊이까지 지원</strong></td>
          </tr>
          <tr>
            <td>암호화</td>
            <td><strong>항상 KMS로 암호화</strong></td>
            <td>SecureString 파라미터만 KMS 암호화</td>
          </tr>
          <tr>
            <td>CloudFormation 통합</td>
            <td>동적 참조 지원</td>
            <td>동적 참조 지원</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box best-practice">
        <div class="info-box-title">Best Practice: 언제 무엇을 사용할까?</div>
        <ul>
          <li><strong>Secrets Manager 사용</strong>: DB 비밀번호(자동 로테이션 필요), 외부 API 키, 교차 계정 접근이 필요할 때</li>
          <li><strong>Parameter Store 사용</strong>: 일반 설정값(URL, 포트, 기능 플래그), 비용을 줄이고 싶을 때, 자동 로테이션이 불필요할 때</li>
          <li><strong>혼합 사용(권장)</strong>: 실무에서는 둘을 함께 사용하는 것이 일반적입니다. 비밀정보는 Secrets Manager에, 일반 설정은 Parameter Store에 저장합니다.</li>
        </ul>
      </div>

      <div class="info-box tip">
        <div class="info-box-title">비용 계산 예시: ShopEasy</div>
        <p>ShopEasy에 10개의 설정값이 있다고 가정합니다 (5개 일반 설정, 5개 비밀 정보).</p>
        <table>
          <thead>
            <tr><th>방식</th><th>월 비용</th><th>계산</th></tr>
          </thead>
          <tbody>
            <tr><td>모두 Secrets Manager</td><td><strong>$4.00 + API 비용</strong></td><td>10 x $0.40 = $4.00</td></tr>
            <tr><td>모두 Parameter Store (Standard)</td><td><strong>$0.00</strong></td><td>Standard tier 무료</td></tr>
            <tr><td>혼합 사용 (권장)</td><td><strong>$2.00</strong></td><td>일반 5개: PS 무료, 비밀 5개: SM $2.00</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Lab A: DB 비밀번호 저장 -->
    <section class="content-section" id="lab-a">
      <h2>7. 실습 A: Secrets Manager에 DB 비밀번호 저장</h2>

      <div class="lab-section">
        <div class="lab-title">실습: Secrets Manager에 ShopEasy DB 비밀번호 저장 및 조회</div>
        <div class="steps">
          <div class="step">
            <div class="step-title">AWS 콘솔에서 시크릿 생성</div>
            <p>AWS Management Console > Secrets Manager > <strong>새 보안 암호 저장(Store a new secret)</strong>을 클릭합니다.</p>
            <ul>
              <li>보안 암호 유형: <strong>Amazon RDS 데이터베이스에 대한 자격 증명</strong></li>
              <li>사용자 이름: <code>admin</code></li>
              <li>암호: <code>ShopEasySecure2024!</code></li>
              <li>암호화 키: <code>aws/secretsmanager</code> (기본값)</li>
              <li>데이터베이스: ShopEasy RDS 인스턴스 선택</li>
            </ul>
          </div>

          <div class="step">
            <div class="step-title">시크릿 이름 및 설정</div>
            <p>시크릿 이름과 설명을 입력합니다.</p>
            <ul>
              <li>보안 암호 이름: <code>shopeasy/prod/db-credentials</code></li>
              <li>설명: ShopEasy 운영 데이터베이스 접속 정보</li>
              <li>태그: <code>Project=ShopEasy</code>, <code>Environment=Production</code></li>
            </ul>
          </div>

          <div class="step">
            <div class="step-title">자동 로테이션 설정 (선택)</div>
            <p>자동 로테이션을 활성화하려면:</p>
            <ul>
              <li>자동 교체 활성화: <strong>켜기</strong></li>
              <li>교체 일정: <strong>30일</strong></li>
              <li>교체 함수: <strong>새 Lambda 함수 생성</strong> 선택</li>
            </ul>
            <div class="info-box warning">
              <div class="info-box-title">실습 환경 참고</div>
              <p>실습 비용을 절약하려면 자동 로테이션은 비활성화 상태로 두세요. 프로덕션 환경에서는 반드시 활성화합니다.</p>
            </div>
          </div>

          <div class="step">
            <div class="step-title">CLI로 시크릿 조회 확인</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 시크릿 조회
aws secretsmanager get-secret-value \
  --secret-id "shopeasy/prod/db-credentials" \
  --query 'SecretString' \
  --output text | python3 -m json.tool

# 출력 예시:
# {
#     "username": "admin",
#     "password": "ShopEasySecure2024!",
#     "engine": "mysql",
#     "host": "shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com",
#     "port": 3306,
#     "dbname": "shopeasy"
# }</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">IAM 정책 확인</div>
            <p>EC2 인스턴스의 IAM 역할에 Secrets Manager 접근 권한이 있는지 확인합니다.</p>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">json</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadSecrets",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:ap-northeast-2:123456789012:secret:shopeasy/prod/*"
      ]
    }
  ]
}</code></pre>
            </div>
            <div class="info-box tip">
              <div class="info-box-title">최소 권한 원칙</div>
              <p>시크릿 ARN 뒤에 랜덤 6자리가 자동으로 추가됩니다. 리소스를 <code>shopeasy/prod/*</code>로 와일드카드를 사용하면 해당 경로 아래의 모든 시크릿에 접근할 수 있습니다.</p>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Node.js 코드에서 시크릿 사용 테스트</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">javascript</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code>// test-secret.js - 시크릿 조회 테스트
const { SecretsManagerClient, GetSecretValueCommand } = require('@aws-sdk/client-secrets-manager');

async function testSecret() {
  const client = new SecretsManagerClient({ region: 'ap-northeast-2' });

  const command = new GetSecretValueCommand({
    SecretId: 'shopeasy/prod/db-credentials'
  });

  const response = await client.send(command);
  const secret = JSON.parse(response.SecretString);

  console.log('DB Host:', secret.host);
  console.log('DB User:', secret.username);
  console.log('DB Name:', secret.dbname);
  // 비밀번호는 로그에 출력하지 않습니다!
  console.log('시크릿 조회 성공!');
}

testSecret();</code></pre>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Lab B: ShopEasy .env 전환 -->
    <section class="content-section" id="lab-b">
      <h2>8. 실습 B: ShopEasy .env를 Secrets Manager로 전환</h2>

      <div class="info-box concept">
        <div class="info-box-title">실습 목표</div>
        <p>현재 ShopEasy 앱은 <code>.env</code> 파일에 모든 설정과 비밀번호를 저장하고 있습니다. 이것을 <strong>일반 설정은 Parameter Store</strong>에, <strong>비밀정보는 Secrets Manager</strong>에 저장하도록 전환합니다.</p>
      </div>

      <h3>전환 계획</h3>

      <table>
        <thead>
          <tr><th>환경변수</th><th>분류</th><th>이전 대상</th></tr>
        </thead>
        <tbody>
          <tr><td>PORT, NODE_ENV, CORS_ORIGIN</td><td>일반 설정</td><td>Parameter Store (String)</td></tr>
          <tr><td>DB_HOST, DB_PORT, DB_NAME</td><td>일반 설정</td><td>Parameter Store (String)</td></tr>
          <tr><td>DB_USER, DB_PASSWORD</td><td>비밀 정보</td><td>Secrets Manager</td></tr>
          <tr><td>JWT_SECRET</td><td>비밀 정보</td><td>Secrets Manager</td></tr>
          <tr><td>AWS_ACCESS_KEY_ID 등</td><td>삭제</td><td>IAM Role로 대체</td></tr>
          <tr><td>STRIPE_SECRET_KEY</td><td>비밀 정보</td><td>Secrets Manager</td></tr>
        </tbody>
      </table>

      <div class="lab-section">
        <div class="lab-title">실습: .env 값들을 Secrets Manager와 Parameter Store로 이전</div>
        <div class="steps">
          <div class="step">
            <div class="step-title">Parameter Store에 일반 설정 저장</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 서버 설정
aws ssm put-parameter --name "/shopeasy/prod/port" --value "5000" --type "String"
aws ssm put-parameter --name "/shopeasy/prod/node-env" --value "production" --type "String"
aws ssm put-parameter --name "/shopeasy/prod/cors-origin" --value "https://shopeasy.example.com" --type "String"

# DB 연결 정보 (비밀번호 제외)
aws ssm put-parameter --name "/shopeasy/prod/db-host" \
  --value "shopeasy-db.abc123.ap-northeast-2.rds.amazonaws.com" --type "String"
aws ssm put-parameter --name "/shopeasy/prod/db-port" --value "3306" --type "String"
aws ssm put-parameter --name "/shopeasy/prod/db-name" --value "shopeasy" --type "String"

# S3 설정
aws ssm put-parameter --name "/shopeasy/prod/s3-bucket" --value "shopeasy-product-images" --type "String"
aws ssm put-parameter --name "/shopeasy/prod/s3-region" --value "ap-northeast-2" --type "String"</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Secrets Manager에 비밀 정보 저장</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># DB 자격증명
aws secretsmanager create-secret \
  --name "shopeasy/prod/db-credentials" \
  --secret-string '{"username":"admin","password":"SuperSecret123!"}'

# JWT 시크릿
aws secretsmanager create-secret \
  --name "shopeasy/prod/jwt-secret" \
  --secret-string '{"secret":"my-super-secret-jwt-key-2024"}'

# Stripe API 키
aws secretsmanager create-secret \
  --name "shopeasy/prod/stripe-keys" \
  --secret-string '{"secret_key":"sk_live_xxxxxxxxxxxxxxxxxxxx"}'</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">EC2에 IAM Role 정책 부여</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">json</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadSecrets",
      "Effect": "Allow",
      "Action": ["secretsmanager:GetSecretValue"],
      "Resource": ["arn:aws:secretsmanager:ap-northeast-2:123456789012:secret:shopeasy/prod/*"]
    },
    {
      "Sid": "ReadParameters",
      "Effect": "Allow",
      "Action": ["ssm:GetParameter", "ssm:GetParametersByPath"],
      "Resource": ["arn:aws:ssm:ap-northeast-2:123456789012:parameter/shopeasy/prod/*"]
    },
    {
      "Sid": "DecryptSecureStrings",
      "Effect": "Allow",
      "Action": ["kms:Decrypt"],
      "Resource": ["arn:aws:kms:ap-northeast-2:123456789012:key/*"]
    }
  ]
}</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">Node.js 코드 수정 - secrets.js 모듈 작성</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">javascript</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code>// config/secrets.js - 시크릿 및 파라미터 로드 모듈
const { SecretsManagerClient, GetSecretValueCommand } = require('@aws-sdk/client-secrets-manager');
const { SSMClient, GetParametersByPathCommand } = require('@aws-sdk/client-ssm');

const REGION = 'ap-northeast-2';
const ENV = process.env.APP_ENV || 'prod';

const smClient = new SecretsManagerClient({ region: REGION });
const ssmClient = new SSMClient({ region: REGION });

async function getSecret(secretName) {
  const command = new GetSecretValueCommand({
    SecretId: `shopeasy/${ENV}/${secretName}`
  });
  const response = await smClient.send(command);
  return JSON.parse(response.SecretString);
}

async function getParameters() {
  const params = {};
  let nextToken;
  do {
    const command = new GetParametersByPathCommand({
      Path: `/shopeasy/${ENV}/`,
      WithDecryption: true,
      NextToken: nextToken
    });
    const response = await ssmClient.send(command);
    for (const param of response.Parameters) {
      const key = param.Name.split('/').pop();
      params[key] = param.Value;
    }
    nextToken = response.NextToken;
  } while (nextToken);
  return params;
}

async function loadConfig() {
  const [params, dbCreds, jwtSecret, stripeKeys] = await Promise.all([
    getParameters(),
    getSecret('db-credentials'),
    getSecret('jwt-secret'),
    getSecret('stripe-keys')
  ]);

  return {
    server: {
      port: parseInt(params['port']) || 5000,
      nodeEnv: params['node-env'] || 'production',
      corsOrigin: params['cors-origin']
    },
    database: {
      host: params['db-host'],
      port: parseInt(params['db-port']) || 3306,
      name: params['db-name'],
      user: dbCreds.username,
      password: dbCreds.password
    },
    jwt: { secret: jwtSecret.secret },
    stripe: { secretKey: stripeKeys.secret_key }
  };
}

module.exports = { loadConfig };</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">server.js 수정</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">javascript</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code>// server.js - 수정 후
const express = require('express');
const mysql = require('mysql2/promise');
const { loadConfig } = require('./config/secrets');

async function startServer() {
  // 1. 설정 로드 (Secrets Manager + Parameter Store)
  const config = await loadConfig();
  console.log(`환경: ${config.server.nodeEnv}`);

  // 2. DB 연결
  const pool = mysql.createPool({
    host: config.database.host,
    port: config.database.port,
    user: config.database.user,
    password: config.database.password,
    database: config.database.name,
    waitForConnections: true,
    connectionLimit: 10
  });

  // 3. Express 앱 설정
  const app = express();
  app.use(express.json());
  app.locals.config = config;
  app.locals.db = pool;

  // 4. 서버 시작
  app.listen(config.server.port, () => {
    console.log(`ShopEasy 서버가 포트 ${config.server.port}에서 시작되었습니다.`);
    console.log('.env 파일 없이 Secrets Manager로 구동 중!');
  });
}

startServer().catch(err => {
  console.error('서버 시작 실패:', err);
  process.exit(1);
});</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">.env 파일 제거 및 정리</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># .env 파일 백업 후 삭제
cp .env .env.backup.$(date +%Y%m%d)
rm .env

# 패키지 설치
npm install @aws-sdk/client-secrets-manager @aws-sdk/client-ssm

# dotenv 패키지 제거 (더 이상 필요 없음)
npm uninstall dotenv

# Git에서 .env 파일이 추적되고 있었다면 제거
git rm --cached .env 2>/dev/null

# .gitignore에 .env 추가
echo ".env" >> .gitignore
echo ".env.*" >> .gitignore</code></pre>
            </div>
          </div>

          <div class="step">
            <div class="step-title">테스트 및 검증</div>
            <div class="code-block">
              <div class="code-header">
                <span class="lang">bash</span>
                <button class="copy-btn">복사</button>
              </div>
              <pre><code># 서버 재시작
APP_ENV=prod node server.js

# API 테스트
curl http://localhost:5000/api/products

# CloudTrail에서 시크릿 접근 확인
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=EventName,AttributeValue=GetSecretValue \
  --max-results 5</code></pre>
            </div>
            <div class="info-box best-practice">
              <div class="info-box-title">전환 체크리스트</div>
              <ul>
                <li>EC2 인스턴스에 적절한 IAM Role이 부여되었는지 확인</li>
                <li>VPC 엔드포인트 또는 NAT Gateway가 설정되었는지 확인 (프라이빗 서브넷)</li>
                <li>코드에서 <code>require('dotenv').config()</code>를 제거했는지 확인</li>
                <li>.env 백업 파일을 안전한 곳에 보관 후 서버에서 삭제</li>
                <li>이전 비밀번호는 즉시 변경 (유출 가능성 대비)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="chapter-nav">
      <a href="12-rds-dynamodb-security.html" class="prev">이전: RDS & DynamoDB 보안</a>
      <a href="14-cloudfront-security.html" class="next">다음: CloudFront 보안</a>
    </div>
  </main>
</div>

<script src="../assets/js/main.js"></script>
</body>

<!-- Mirrored from rapa-aws-security.vercel.app/chapters/13-secrets-manager.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 26 Feb 2026 08:26:36 GMT -->
</html>
